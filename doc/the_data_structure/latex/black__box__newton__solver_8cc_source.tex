\hypertarget{black__box__newton__solver_8cc_source}{}\doxysection{black\+\_\+box\+\_\+newton\+\_\+solver.\+cc}
\label{black__box__newton__solver_8cc_source}\index{black\_box\_newton\_solver.cc@{black\_box\_newton\_solver.cc}}
\mbox{\hyperlink{black__box__newton__solver_8cc}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00001}00001 \textcolor{comment}{// LIC// ====================================================================}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00002}00002 \textcolor{comment}{// LIC// This file forms part of oomph-\/lib, the object-\/oriented,}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00003}00003 \textcolor{comment}{// LIC// multi-\/physics finite-\/element library, available}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00004}00004 \textcolor{comment}{// LIC// at http://www.oomph-\/lib.org.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00005}00005 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00006}00006 \textcolor{comment}{// LIC// Copyright (C) 2006-\/2021 Matthias Heil and Andrew Hazel}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00007}00007 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00008}00008 \textcolor{comment}{// LIC// This library is free software; you can redistribute it and/or}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00009}00009 \textcolor{comment}{// LIC// modify it under the terms of the GNU Lesser General Public}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00010}00010 \textcolor{comment}{// LIC// License as published by the Free Software Foundation; either}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00011}00011 \textcolor{comment}{// LIC// version 2.1 of the License, or (at your option) any later version.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00012}00012 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00013}00013 \textcolor{comment}{// LIC// This library is distributed in the hope that it will be useful,}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00014}00014 \textcolor{comment}{// LIC// but WITHOUT ANY WARRANTY; without even the implied warranty of}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00015}00015 \textcolor{comment}{// LIC// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00016}00016 \textcolor{comment}{// LIC// Lesser General Public License for more details.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00017}00017 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00018}00018 \textcolor{comment}{// LIC// You should have received a copy of the GNU Lesser General Public}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00019}00019 \textcolor{comment}{// LIC// License along with this library; if not, write to the Free Software}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00020}00020 \textcolor{comment}{// LIC// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00021}00021 \textcolor{comment}{// LIC// 02110-\/1301  USA.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00022}00022 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00023}00023 \textcolor{comment}{// LIC// The authors may be contacted at oomph-\/lib@maths.man.ac.uk.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00024}00024 \textcolor{comment}{// LIC//}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00025}00025 \textcolor{comment}{// LIC//====================================================================}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00026}00026 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00027}00027 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00028}00028 \textcolor{comment}{// Config header generated by autoconfig}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00029}00029 \textcolor{preprocessor}{\#ifdef HAVE\_CONFIG\_H}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00030}00030 \textcolor{preprocessor}{\#include <oomph-\/lib-\/config.h>}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00031}00031 \textcolor{preprocessor}{\#endif}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00032}00032 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00033}00033 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{black__box__newton__solver_8h}{black\_box\_newton\_solver.h}}"{}}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00034}00034 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00035}00035 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00036}00036 \textcolor{keyword}{namespace }\mbox{\hyperlink{namespaceoomph}{oomph}}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00037}00037 \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00038}00038   \textcolor{comment}{//======================================================================}\textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00039}00039 \textcolor{comment}{  /// Namespace for black-\/box FD Newton solver.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00040}00040 \textcolor{comment}{}  \textcolor{comment}{//======================================================================}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00041}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver}{00041}}   \textcolor{keyword}{namespace }BlackBoxFDNewtonSolver}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00042}00042   \{\textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00043}00043 \textcolor{comment}{    /// Max. \# of Newton iterations}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00044}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a20ac8568daf0d63afa3945a817ff3e2d}{00044}} \textcolor{comment}{}    \textcolor{keywordtype}{unsigned} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a20ac8568daf0d63afa3945a817ff3e2d}{Max\_iter}} = 20;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00045}00045 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00046}00046 \textcolor{comment}{    /// Number of Newton iterations taken in most recent invocation}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00047}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a3067ba88fad991fdb619eae7533028bd}{00047}} \textcolor{comment}{}    \textcolor{keywordtype}{unsigned} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a3067ba88fad991fdb619eae7533028bd}{N\_iter\_taken}} = 0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00048}00048 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00049}00049 \textcolor{comment}{    /// Flag to indicate if progress of Newton iteration is to be}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00050}00050 \textcolor{comment}{    /// documented (defaults to false)}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00051}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ac2603699f47446716ca5a818f46a7f17}{00051}} \textcolor{comment}{}    \textcolor{keywordtype}{bool} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ac2603699f47446716ca5a818f46a7f17}{Doc\_Progress}} = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00052}00052 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00053}00053 \textcolor{comment}{    /// FD step}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00054}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a6f0d2ceb4451e66bb7ef4ab4fdb62bcf}{00054}} \textcolor{comment}{}    \textcolor{keywordtype}{double} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a6f0d2ceb4451e66bb7ef4ab4fdb62bcf}{FD\_step}} = 1.0e-\/8;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00055}00055 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00056}00056 \textcolor{comment}{    /// Tolerance}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00057}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4bacc59c8e1194e553f698530e9e945e}{00057}} \textcolor{comment}{}    \textcolor{keywordtype}{double} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4bacc59c8e1194e553f698530e9e945e}{Tol}} = 1.0e-\/8;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00058}00058 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00059}00059 \textcolor{comment}{    /// Use steplength control do make globally convergent (default false)}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00060}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_afd90cb451fb7ae5a8e30cab0a1884568}{00060}} \textcolor{comment}{}    \textcolor{keywordtype}{bool} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_afd90cb451fb7ae5a8e30cab0a1884568}{Use\_step\_length\_control}} = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00061}00061 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00062}00062 \textcolor{comment}{    /// Black-\/box FD Newton solver:}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00063}00063 \textcolor{comment}{    /// Calling sequence for residual function is}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00064}00064 \textcolor{comment}{    /// \(\backslash\)code residual\_fct(parameters,unknowns,residuals) \(\backslash\)endcode}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00065}00065 \textcolor{comment}{    /// where all arguments are double Vectors.}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00066}00066 \textcolor{comment}{    /// unknowns.size() = residuals.size()}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00067}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ae132e48f67e6523676abad29b61397ba}{00067}} \textcolor{comment}{}    \textcolor{keywordtype}{void} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ae132e48f67e6523676abad29b61397ba}{black\_box\_fd\_newton\_solve}}(\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ae43745d4b8933505d52d50820c5ed5bf}{ResidualFctPt}} residual\_fct,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00068}00068                                    \textcolor{keyword}{const} \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& params,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00069}00069                                    \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& unknowns,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00070}00070                                    \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a6a8995752628445edff43f942b4d3e88}{JacobianFctPt}} jacobian\_fct)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00071}00071     \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00072}00072       \textcolor{comment}{// Jacobian, current and advanced residual Vectors}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00073}00073       \textcolor{keywordtype}{unsigned} ndof = unknowns.size();}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00074}00074       \mbox{\hyperlink{classoomph_1_1DenseDoubleMatrix}{DenseDoubleMatrix}} jacobian(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00075}00075       \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} residuals(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00076}00076       \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} residuals\_pls(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00077}00077       \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} dx(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00078}00078       \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} gradient(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00079}00079       \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} newton\_direction(ndof);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00080}00080 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00081}00081       \textcolor{keywordtype}{double} half\_residual\_squared = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00082}00082       \textcolor{keywordtype}{double} max\_step = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00083}00083 \textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00084}00084 \textcolor{comment}{      /// Reset number of Newton iterations taken in most recent invocation}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00085}00085 \textcolor{comment}{}      \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a3067ba88fad991fdb619eae7533028bd}{N\_iter\_taken}} = 0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00086}00086 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00087}00087       \textcolor{comment}{// Newton iterations}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00088}00088       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} iloop = 0; iloop < \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a20ac8568daf0d63afa3945a817ff3e2d}{Max\_iter}}; iloop++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00089}00089       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00090}00090         \textcolor{comment}{// Evaluate current residuals}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00091}00091         residual\_fct(params, unknowns, residuals);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00092}00092 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00093}00093         \textcolor{comment}{// Get half of squared residual and find maximum step length}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00094}00094         \textcolor{comment}{// for step length control}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00095}00095         \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_afd90cb451fb7ae5a8e30cab0a1884568}{Use\_step\_length\_control}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00096}00096         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00097}00097           half\_residual\_squared = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00098}00098           \textcolor{keywordtype}{double} sum = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00099}00099           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00100}00100           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00101}00101             sum += unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] * unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00102}00102             half\_residual\_squared += residuals[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] * residuals[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00103}00103           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00104}00104           half\_residual\_squared *= 0.5;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00105}00105           max\_step = 100.0 * std::max(sqrt(sum), \textcolor{keywordtype}{double}(ndof));}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00106}00106         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00107}00107 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00108}00108 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00109}00109         \textcolor{comment}{// Check max. residuals}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00110}00110         \textcolor{keywordtype}{double} max\_res = std::fabs(*std::max\_element(}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00111}00111           residuals.begin(), residuals.end(), \mbox{\hyperlink{classoomph_1_1AbsCmp}{AbsCmp<double>}}()));}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00112}00112 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00113}00113 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00114}00114         \textcolor{comment}{// Doc progress?}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00115}00115         \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ac2603699f47446716ca5a818f46a7f17}{Doc\_Progress}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00116}00116         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00117}00117           \mbox{\hyperlink{namespaceoomph_aec474227917784dc0a255faf289cfc16}{oomph\_info}} << \textcolor{stringliteral}{"{}\(\backslash\)nNewton iteration iter="{}} << iloop}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00118}00118                      << \textcolor{stringliteral}{"{}\(\backslash\)ni residual[i] unknown[i] "{}} << std::endl;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00119}00119           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00120}00120           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00121}00121             \mbox{\hyperlink{namespaceoomph_aec474227917784dc0a255faf289cfc16}{oomph\_info}} << \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} << \textcolor{stringliteral}{"{} "{}} << residuals[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] << \textcolor{stringliteral}{"{} "{}} << unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}]}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00122}00122                        << std::endl;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00123}00123           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00124}00124         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00125}00125 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00126}00126 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00127}00127         \textcolor{comment}{// Converged?}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00128}00128         \textcolor{keywordflow}{if} (max\_res < \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4bacc59c8e1194e553f698530e9e945e}{Tol}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00129}00129         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00130}00130           \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00131}00131         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00132}00132 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00133}00133         \textcolor{comment}{// Next iteration...}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00134}00134         \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a3067ba88fad991fdb619eae7533028bd}{N\_iter\_taken}}++;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00135}00135 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00136}00136         \textcolor{comment}{// ...and how would Sir like his Jacobian?}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00137}00137         \textcolor{keywordflow}{if} (jacobian\_fct == 0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00138}00138         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00139}00139           \textcolor{comment}{// FD loop for Jacobian}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00140}00140           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00141}00141           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00142}00142             \textcolor{keywordtype}{double} backup = unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00143}00143             unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] += \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a6f0d2ceb4451e66bb7ef4ab4fdb62bcf}{FD\_step}};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00144}00144 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00145}00145             \textcolor{comment}{// Evaluate advanced residuals}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00146}00146             residual\_fct(params, unknowns, residuals\_pls);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00147}00147 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00148}00148             \textcolor{comment}{// Do FD}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00149}00149             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} j = 0; j < ndof; j++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00150}00150             \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00151}00151               jacobian(j, \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}) = (residuals\_pls[j] -\/ residuals[j]) / \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a6f0d2ceb4451e66bb7ef4ab4fdb62bcf}{FD\_step}};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00152}00152             \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00153}00153 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00154}00154             \textcolor{comment}{// Reset fd step}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00155}00155             unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] = backup;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00156}00156           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00157}00157         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00158}00158         \textcolor{comment}{// Analytical Jacobian}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00159}00159         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00160}00160         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00161}00161           jacobian\_fct(params, unknowns, jacobian);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00162}00162         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00163}00163 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00164}00164 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00165}00165         \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ac2603699f47446716ca5a818f46a7f17}{Doc\_Progress}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00166}00166         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00167}00167           \mbox{\hyperlink{namespaceoomph_aec474227917784dc0a255faf289cfc16}{oomph\_info}} << \textcolor{stringliteral}{"{}\(\backslash\)n\(\backslash\)nJacobian: "{}} << std::endl;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00168}00168           jacobian.\mbox{\hyperlink{classoomph_1_1Matrix_a4f97fa3c94e6fd664e46acb8873a80f8}{sparse\_indexed\_output}}(*(\mbox{\hyperlink{namespaceoomph_aec474227917784dc0a255faf289cfc16}{oomph\_info}}.\mbox{\hyperlink{classoomph_1_1OomphInfo_a353cd56d96da9152d6d730b328c07a06}{stream\_pt}}()));}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00169}00169           \mbox{\hyperlink{namespaceoomph_aec474227917784dc0a255faf289cfc16}{oomph\_info}} << std::endl;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00170}00170         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00171}00171 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00172}00172         \textcolor{comment}{// Get gradient}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00173}00173         \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_afd90cb451fb7ae5a8e30cab0a1884568}{Use\_step\_length\_control}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00174}00174         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00175}00175           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00176}00176           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00177}00177             \textcolor{keywordtype}{double} sum = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00178}00178             \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} j = 0; j < ndof; j++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00179}00179             \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00180}00180               sum += jacobian(j, \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}) * residuals[j];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00181}00181             \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00182}00182             gradient[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] = sum;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00183}00183           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00184}00184         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00185}00185 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00186}00186         \textcolor{comment}{// Solve}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00187}00187         jacobian.\mbox{\hyperlink{classoomph_1_1DoubleMatrixBase_a4d445c4a1204da569f40ec1bdace9ef3}{solve}}(residuals, newton\_direction);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00188}00188 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00189}00189         \textcolor{comment}{// Update}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00190}00190         \textcolor{keywordflow}{if} (\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_afd90cb451fb7ae5a8e30cab0a1884568}{Use\_step\_length\_control}})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00191}00191         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00192}00192           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00193}00193           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00194}00194             newton\_direction[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] *= -\/1.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00195}00195           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00196}00196           \textcolor{comment}{// Update with steplength control}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00197}00197           \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} unknowns\_old(unknowns);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00198}00198           \textcolor{keywordtype}{double} half\_residual\_squared\_old = half\_residual\_squared;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00199}00199           \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4a1361a9b08163b59fe82b3042b0f887}{line\_search}}(unknowns\_old,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00200}00200                       half\_residual\_squared\_old,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00201}00201                       gradient,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00202}00202                       residual\_fct,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00203}00203                       params,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00204}00204                       newton\_direction,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00205}00205                       unknowns,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00206}00206                       half\_residual\_squared,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00207}00207                       max\_step);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00208}00208         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00209}00209         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00210}00210         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00211}00211           \textcolor{comment}{// Direct Newton update:}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00212}00212           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < ndof; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00213}00213           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00214}00214             unknowns[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] -\/= newton\_direction[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00215}00215           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00216}00216         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00217}00217       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00218}00218 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00219}00219 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00220}00220       \textcolor{comment}{// Failed to converge}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00221}00221       std::ostringstream error\_stream;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00222}00222       error\_stream << \textcolor{stringliteral}{"{}Newton solver did not converge in "{}} << \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a20ac8568daf0d63afa3945a817ff3e2d}{Max\_iter}}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00223}00223                    << \textcolor{stringliteral}{"{} steps "{}} << std::endl;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00224}00224 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00225}00225       \textcolor{keywordflow}{throw} \mbox{\hyperlink{classoomph_1_1OomphLibError}{OomphLibError}}(}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00226}00226         error\_stream.str(), OOMPH\_CURRENT\_FUNCTION, OOMPH\_EXCEPTION\_LOCATION);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00227}00227     \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00228}00228 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00229}00229 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00230}00230     \textcolor{comment}{//=======================================================================}\textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00231}00231 \textcolor{comment}{    /// Line search helper for globally convergent Newton method}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00232}00232 \textcolor{comment}{}    \textcolor{comment}{//=======================================================================}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00233}\mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4a1361a9b08163b59fe82b3042b0f887}{00233}}     \textcolor{keywordtype}{void} \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_a4a1361a9b08163b59fe82b3042b0f887}{line\_search}}(\textcolor{keyword}{const} \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& x\_old,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00234}00234                      \textcolor{keyword}{const} \textcolor{keywordtype}{double} half\_residual\_squared\_old,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00235}00235                      \textcolor{keyword}{const} \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& gradient,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00236}00236                      \mbox{\hyperlink{namespaceoomph_1_1BlackBoxFDNewtonSolver_ae43745d4b8933505d52d50820c5ed5bf}{ResidualFctPt}} residual\_fct,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00237}00237                      \textcolor{keyword}{const} \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& params,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00238}00238                      \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& newton\_dir,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00239}00239                      \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}}\& x,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00240}00240                      \textcolor{keywordtype}{double}\& half\_residual\_squared,}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00241}00241                      \textcolor{keyword}{const} \textcolor{keywordtype}{double}\& stpmax)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00242}00242     \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00243}00243       \textcolor{keyword}{const} \textcolor{keywordtype}{double} min\_fct\_decrease = 1.0e-\/4;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00244}00244       \textcolor{keywordtype}{double} convergence\_tol\_on\_x = 1.0e-\/16;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00245}00245       \textcolor{keywordtype}{double} f\_aux = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00246}00246       \textcolor{keywordtype}{double} lambda\_aux = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00247}00247       \textcolor{keywordtype}{double} proposed\_lambda = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00248}00248       \textcolor{keywordtype}{unsigned} n = x\_old.size();}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00249}00249       \textcolor{keywordtype}{double} sum = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00250}00250       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00251}00251       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00252}00252         sum += newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] * newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00253}00253       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00254}00254       sum = sqrt(sum);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00255}00255       \textcolor{keywordflow}{if} (sum > stpmax)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00256}00256       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00257}00257         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00258}00258         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00259}00259           newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] *= stpmax / sum;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00260}00260         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00261}00261       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00262}00262       \textcolor{keywordtype}{double} slope = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00263}00263       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00264}00264       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00265}00265         slope += gradient[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] * newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00266}00266       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00267}00267       \textcolor{keywordflow}{if} (slope >= 0.0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00268}00268       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00269}00269         std::ostringstream error\_stream;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00270}00270         error\_stream << \textcolor{stringliteral}{"{}Roundoff problem in lnsrch: slope="{}} << slope << \textcolor{stringliteral}{"{}\(\backslash\)n"{}};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00271}00271         \textcolor{keywordflow}{throw} \mbox{\hyperlink{classoomph_1_1OomphLibError}{OomphLibError}}(}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00272}00272           error\_stream.str(), OOMPH\_CURRENT\_FUNCTION, OOMPH\_EXCEPTION\_LOCATION);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00273}00273       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00274}00274       \textcolor{keywordtype}{double} test = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00275}00275       \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00276}00276       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00277}00277         \textcolor{keywordtype}{double} temp =}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00278}00278           std::fabs(newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}]) / std::max(std::fabs(x\_old[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}]), 1.0);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00279}00279         \textcolor{keywordflow}{if} (temp > test) test = temp;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00280}00280       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00281}00281       \textcolor{keywordtype}{double} lambda\_min = convergence\_tol\_on\_x / test;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00282}00282       \textcolor{keywordtype}{double} lambda = 1.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00283}00283       \textcolor{keywordflow}{while} (\textcolor{keyword}{true})}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00284}00284       \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00285}00285         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00286}00286         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00287}00287           x[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] = x\_old[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] + lambda * newton\_dir[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00288}00288         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00289}00289 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00290}00290         \textcolor{comment}{// Evaluate current residuals}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00291}00291         \mbox{\hyperlink{classoomph_1_1Vector}{Vector<double>}} residuals(n);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00292}00292         residual\_fct(params, x, residuals);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00293}00293         half\_residual\_squared = 0.0;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00294}00294         \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00295}00295         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00296}00296           half\_residual\_squared += residuals[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] * residuals[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00297}00297         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00298}00298         half\_residual\_squared *= 0.5;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00299}00299 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00300}00300         \textcolor{keywordflow}{if} (lambda < lambda\_min)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00301}00301         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00302}00302           \textcolor{keywordflow}{for} (\textcolor{keywordtype}{unsigned} \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} = 0; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}} < n; \mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}++) x[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}] = x\_old[\mbox{\hyperlink{cfortran_8h_adb50e893b86b3e55e751a42eab3cba82}{i}}];}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00303}00303 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00304}00304           \textcolor{comment}{// Create an Oomph Lib warning}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00305}00305           \mbox{\hyperlink{classoomph_1_1OomphLibWarning}{OomphLibWarning}}(\textcolor{stringliteral}{"{}Warning: Line search converged on x only!"{}},}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00306}00306                           \textcolor{stringliteral}{"{}BlackBoxFDNewtonSolver::line\_search()"{}},}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00307}00307                           OOMPH\_EXCEPTION\_LOCATION);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00308}00308           \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00309}00309         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00310}00310         \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (half\_residual\_squared <=}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00311}00311                  half\_residual\_squared\_old + min\_fct\_decrease * lambda * slope)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00312}00312         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00313}00313           \textcolor{keywordflow}{return};}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00314}00314         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00315}00315         \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00316}00316         \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00317}00317           \textcolor{keywordflow}{if} (lambda == 1.0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00318}00318           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00319}00319             proposed\_lambda =}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00320}00320               -\/slope / (2.0 * (half\_residual\_squared -\/}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00321}00321                                half\_residual\_squared\_old -\/ slope));}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00322}00322           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00323}00323           \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00324}00324           \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00325}00325             \textcolor{keywordtype}{double} r1 = half\_residual\_squared -\/ half\_residual\_squared\_old -\/}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00326}00326                         lambda * slope;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00327}00327             \textcolor{keywordtype}{double} r2 = f\_aux -\/ half\_residual\_squared\_old -\/ lambda\_aux * slope;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00328}00328             \textcolor{keywordtype}{double} a\_poly =}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00329}00329               (r1 / (lambda * lambda) -\/ r2 / (lambda\_aux * lambda\_aux)) /}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00330}00330               (lambda -\/ lambda\_aux);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00331}00331             \textcolor{keywordtype}{double} b\_poly = (-\/lambda\_aux * r1 / (lambda * lambda) +}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00332}00332                              lambda * r2 / (lambda\_aux * lambda\_aux)) /}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00333}00333                             (lambda -\/ lambda\_aux);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00334}00334             \textcolor{keywordflow}{if} (a\_poly == 0.0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00335}00335             \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00336}00336               proposed\_lambda = -\/slope / (2.0 * b\_poly);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00337}00337             \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00338}00338             \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00339}00339             \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00340}00340               \textcolor{keywordtype}{double} discriminant = b\_poly * b\_poly -\/ 3.0 * a\_poly * slope;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00341}00341               \textcolor{keywordflow}{if} (discriminant < 0.0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00342}00342               \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00343}00343                 proposed\_lambda = 0.5 * lambda;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00344}00344               \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00345}00345               \textcolor{keywordflow}{else} \textcolor{keywordflow}{if} (b\_poly <= 0.0)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00346}00346               \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00347}00347                 proposed\_lambda =}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00348}00348                   (-\/b\_poly + sqrt(discriminant)) / (3.0 * a\_poly);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00349}00349               \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00350}00350               \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00351}00351               \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00352}00352                 proposed\_lambda = -\/slope / (b\_poly + sqrt(discriminant));}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00353}00353               \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00354}00354             \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00355}00355             \textcolor{keywordflow}{if} (proposed\_lambda > 0.5 * lambda)}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00356}00356             \{}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00357}00357               proposed\_lambda = 0.5 * lambda;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00358}00358             \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00359}00359           \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00360}00360         \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00361}00361         lambda\_aux = lambda;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00362}00362         f\_aux = half\_residual\_squared;}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00363}00363         lambda = std::max(proposed\_lambda, 0.1 * lambda);}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00364}00364       \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00365}00365     \}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00366}00366   \} \textcolor{comment}{// namespace BlackBoxFDNewtonSolver}}
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00367}00367 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00368}00368 }
\DoxyCodeLine{\Hypertarget{black__box__newton__solver_8cc_source_l00369}00369 \} \textcolor{comment}{// namespace oomph}}

\end{DoxyCode}
