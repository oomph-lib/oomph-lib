<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>oomph-lib: Linking VMTK with oomph-lib</title>
<link rel="apple-touch-icon" sizes="57x57" href="../../../figures/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../../../figures/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../../../figures/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../../../figures/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../../../figures/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../../../figures/apple-touch-icon-120x120.png">
<link rel="icon" type="image/png" href="../../../figures/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../figures/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../figures/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="../../../figures/manifest.json">
<link rel="mask-icon" href="../../../figures/safari-pinned-tab.svg" color="#008000">
<link rel="shortcut icon" href="../../../figures/favicon.ico">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-config" content="../../../figures/browserconfig.xml">
<meta name="theme-color" content="#008000">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600" rel="stylesheet" type="text/css">
<!-- Doxygen css-->
<!-- <link rel="stylesheet" type="text/css" href="doxygen.css"> -->
<!-- Bootstrap -->
<link href="../../../css/bootstrap.css" rel="stylesheet">
<!-- oomph-lib specific overrides -->
<link rel="stylesheet" type="text/css" href="../../../css/oomph_header.css">
</head>
<body>
<nav class="navbar navbar-default">
<div class="container">
<div class="container-fluid">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="../../../html/index.html"><img alt="oomph-lib" src="../../../figures/oomph_logo.png"></a>
  </div>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">          
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Big picture</li>
          <li><a href="../../../../doc/intro/html/index.html">The finite element method</a></li>
          <li><a href="../../../../doc/the_data_structure/html/index.html">The data structure</a></li>
          <li><a href="../../../../doc/quick_guide/html/index.html">Not-so-quick guide</a></li>
          <li><a href="../../../../doc/optimisation/html/index.html">Optimisation</a></li>
          <li><a href="../../../../doc/order_of_action_functions/html/index.html">Order of action functions</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Example codes and tutorials</li>
          <li><a href="../../../../doc/example_code_list/html/index.html">List of example codes and tutorials</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#meshes">Meshing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#solvers">Solvers</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#parallel">MPI parallel processing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#visualisation">Post-processing/visualisation</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Other</li>
          <li><a href="../../../../doc/change_log/html/index.html">Change log</a></li>
          <li><a href="../../../../doc/creating_doc/html/index.html">Creating documentation</a></li>
          <li><a href="../../../../doc/coding_conventions/html/index.html">Coding conventions</a></li>
          <li><a href="../../../../doc/index/html/index.html">Index</a></li>
          <li><a href="../../../../doc/FAQ/html/index.html">FAQ</a></li>
        </ul>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Installation<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/the_distribution/html/index.html">Installation guide</a></li>
            <li><a href="../../../../doc/copyright/html/index.html">Copyright</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/people/html/index.html">People</a></li>            
            <li><a href="../../../../doc/contact/html/index.html">Contact/Get involved</a></li>
            <li><a href="../../../../doc/publications/html/index.html">Publications</a></li>
            <li><a href="../../../../doc/acknowledgements/html/index.html">Acknowledgements</a></li>
            <li><a href="../../../../doc/picture_show/index.html">Picture show</a></li>
          </ul>
        </li>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right navbar-search">
      <form class="navbar-form" role="search" action="../../../../doc/search_results/html/index.html">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search" name="q">
          <span class="input-group-btn">
            <button class="btn btn-default" type="submit">Go</button>
          </span>
        </div><!-- /input-group -->
       <!--<div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>-->
      </form>
    </ul>
  </div><!-- /.navbar-collapse -->
</div><!-- /.container-fluid -->
</div>
</nav>
<!-- Generated by Doxygen 1.9.2 -->
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Linking VMTK with oomph-lib </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >The <a href="http://www.vmtk.org">Vascular Modeling Toolkit</a> is a collection of libraries and tools for the 3D reconstruction, geometric analysis, mesh generation and surface data analysis for image-based modelling of blood vessels.</p>
<p >This tutorial demonstrates how to open your dataset in VMTK; navigate around a 3D volume; reconstruct the 3D surface of a vascular segment from CT or MR images; process a surface model to generate a mesh; and how to extract the surface mesh. Finally, we demonstrate how to use <code>oomph-lib's</code> conversion code <code>create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh</code> to generate fluid and solid meshes that allow the simulation of physiological fluid-structure interaction problems in which the (assumed constant thickness) vessel wall deforms in response to the fluid traction.</p>
<p >Before starting, make sure that you have VMTK installed on your machine and that you have your DICOM (Digital Imaging and Communications in Medicine) images. Note that this tutorial describes the use of VMTK version 0.8.</p>
<p >For further information on VMTK, please refer to VMTK's <a href="http://www.vmtk.org">home page</a>.</p>
<center> <table border="1," width="500px">
<tr>
<td bgcolor="cornsilk"><center> <b>Acknowledgement:</b> </center> This tutorial and the associated driver codes were developed jointly with Amine Massit (ENSTA, Paris).   </td></tr>
</table>
</center><center> <table border="1," width="500px">
<tr>
<td bgcolor="cornsilk"><center> <b>Disclaimer:</b> </center><p> The generation of high-quality computational meshes from medical images is a non-trivial task. The <a href="http://www.vmtk.org">Vascular Modeling Toolkit</a> greatly simplifies this task but it is important to remember that (intelligent) user input is required at various stages of the process.</p>
<p class="endtd">This tutorial does <b>not</b> provide any guidance on this aspect. We simply demonstrate <b>how</b> to generate meshes that can be used in <code>oomph-lib</code> - based <br  />
 physiological flow (or fluid-structure interaction) simulations. If you smooth the vessels walls too much, you may lose essential features; if you smooth too little, the shape of the vessel wall may be polluted by imaging artifacts; etc.   </p>
</td></tr>
</table>
</center><hr  />
 <hr  />
<h1><a class="anchor" id="vmtk"></a>
Using VMTK: From the MR/CT images to the fluid mesh</h1>
<h2><a class="anchor" id="voi"></a>
Volume of interest</h2>
<p >VMTK is capable of reading DICOM directories (which contain the files with .dcm extension). You can open your dataset in VMTK and navigate around the 3D volume with: </p><div class="fragment"><div class="line">vmtkimagereader -f dicom -d dicom_directory --pipe vmtkimageviewer</div>
</div><!-- fragment --><p >where <code>dicom_directory</code> is the path to the directory containing the .dcm files.</p>
<div class="image">
<img src="scan.gif" alt=""/>
</div>
 <p >Once the viewer pops up, you can:</p>
<ul>
<li>Rotate the volume by left-clicking anywhere on the render window (outside the image).</li>
<li>Translate the volume by middle-clicking anywhere on the render window (outside the image).</li>
<li>Zoom the volume by right-clicking anywhere on the render window (outside the image).</li>
<li>Probe the image planes (coordinates and graylevel) by left-clicking on them.</li>
<li>Move through the image planes by middle-clicking on them.</li>
<li>Change the window-level by right-clicking on image planes.</li>
<li>Quit the viewer by pressing <code>q</code> or <code>e</code>.</li>
</ul>
<p >You can extract a volume of interest (VOI) from a dataset with :</p>
<div class="fragment"><div class="line"> vmtkimagereader -f dicom -d dicom_directory --pipe \</div>
<div class="line">vmtkimagevoiselector -ofile image_volume_voi.vti</div>
</div><!-- fragment --><p >where the argument to the <code>-ofile</code> option specifies the output file name.</p>
<p >When the render window pops up, pressing <code>i</code> will activate the "interactor": a yellowish cube will appear that is used to select the VOI.</p>
<div class="image">
<img src="voi_cube.gif" alt=""/>
</div>
  <pre class="fragment">- Translate the cube by middle-clicking on it.
- Resize the cube by left-clicking and dragging the little spheres 
</pre><p> (handles) on the faces of the cube.</p><ul>
<li>Normal interaction with the image is still active, so you can still navigate in the image as explained before.</li>
</ul>
<div class="image">
<img src="voi_cube2.gif" alt=""/>
</div>
 <p >When satisfied with the VOI, press <code>q</code> or <code>e</code>. The new volume is displayed in the render window.</p>
<div class="image">
<img src="voi.gif" alt=""/>
</div>
 <p >You can quit by pressing <code>q</code> or <code>e</code>, or you can define another VOI by pressing <code>i</code> once again.</p>
<hr  />
 <hr  />
<h2><a class="anchor" id="surface"></a>
The 3D surface reconstruction of a vascular segment</h2>
<p >VMTK is capable of generating an image based surface model from a <code>vti</code> file (obtained using the procedure explained in the section <a class="el" href="index.html#voi">Volume of interest</a> above), using the Level Set method and can then extract the surface model using a Marching Cubes algorithm.</p>
<p >First, enter: </p><div class="fragment"><div class="line">vmtklevelsetsegmentation -ifile image_volume_voi.vti -ofile level_sets.vti</div>
</div><!-- fragment --><div class="image">
<img src="voi_display.gif" alt=""/>
</div>
 <p >When the VOI is displayed in a render window, press <code>q</code> or <code>e</code> to proceed.</p>
<p >A message will appear on your terminal:</p>
<div class="fragment"><div class="line">Please choose initialization type: (0: colliding fronts; 1: fast</div>
<div class="line">marching; 2: threshold; 3: isosurface)</div>
</div><!-- fragment --><p >This lets you choose the initialization method used to create the model of the blood vessel. In this tutorial, we will only demonstrate the <code>colliding</code> <code>fronts</code> method. In this method two seeds are placed on the image. Two fronts are then propagated from the seeds (one front from each) with their speeds proportional to the image intensity. The region where the two fronts cross (or collide), defines the "deformable model" &ndash; the initial representation of the vessel volume. For further information on this and the other initialization methods, please refer to VMTK's <a href="http://www.vmtk.org">tutorial page</a>.</p>
<p >Now, enter <code>0</code> to initialise with <code>colliding</code> <code>fronts</code>.</p>
<p >A message will then appear on the terminal: </p><div class="fragment"><div class="line">Please input lower threshold (<span class="charliteral">&#39;i&#39;</span> to activate image, <span class="charliteral">&#39;n&#39;</span> <span class="keywordflow">for</span> none):</div>
</div><!-- fragment --><p >Wave propagation, used in the <code>colliding</code> <code>fronts</code> method, can be restricted to a set of intensity levels between two thresholds. Enter the lower threshold, if you want to use one, otherwise enter <code>n</code>. Note that if you don't know the appropriate threshold value you can press <code>i</code> to activate the image and probe it, then quit with <code>q</code> or <code>e</code> when probing is done.</p>
<p >For our example there is no need for thresholds. Therefore enter <code>n</code>.</p>
<p >The next message is: </p><div class="fragment"><div class="line">Please input upper threshold (<span class="charliteral">&#39;i&#39;</span> to activate image, <span class="charliteral">&#39;n&#39;</span> <span class="keywordflow">for</span> none):</div>
</div><!-- fragment --><p >We repeat the same steps as for the lower threshold.</p>
<p >Next, this message appears: </p><div class="fragment"><div class="line">Please place two seeds (click on the image <span class="keywordflow">while</span> pressing Ctrl).</div>
</div><!-- fragment --><p >The render window is now activated. Place the two seeds, one at each of the two ends of a branch. (The geometry of the entire bifurcation is created by "merging" the surfaces of individual branches.) Interact with the image planes to find where you want to place your first seed. When satisfied, left-click on the image while pressing <code>Ctrl</code>. A red sphere will then appear.</p>
<div class="image">
<img src="seed1.gif" alt=""/>
</div>
 <p >Repeat this procedure for the second seed. Press <code>q</code> or <code>e</code> when done.</p>
<div class="image">
<img src="seed2.gif" alt=""/>
</div>
 <p >Provided everything went OK, a translucent surface will appear in the render window between the two seeds. This is your initial deformable model.</p>
<div class="image">
<img src="deformable_model1.gif" alt=""/>
</div>
 <p >Press <code>q</code> or <code>e</code> to proceed.</p>
<p >Next, you will be prompted with: </p><div class="fragment"><div class="line">Accept initialization? (y/n):</div>
</div><!-- fragment --><p >If you are not satisfied with your initialisation, enter <code>n</code> to perform it once again, otherwise enter <code>y</code>.</p>
<p >Now press <code>q</code> or <code>e</code> again (in fact, you should do this whenever the system appears to be frozen and the message "Displaying" is shown on the terminal.).</p>
<p >You are now prompted if you want to initialise another branch:</p>
<div class="fragment"><div class="line">Initialize another branch? (y/n): </div>
</div><!-- fragment --><p >Press <code>n</code> &ndash; we will add the other branches later.</p>
<p >The following message will now appear:</p>
<div class="fragment"><div class="line">Please input parameters (type <span class="keywordflow">return</span> to accept current values, <span class="charliteral">&#39;e&#39;</span> to</div>
<div class="line">end, <span class="charliteral">&#39;q&#39;</span> to quit):</div>
<div class="line"> NumberOfIterations(0) [PropagationScaling(1.0) CurvatureScaling(0.0) </div>
<div class="line">AdvectionScaling(0.0)]:</div>
</div><!-- fragment --><p >These parameters control the deformation of your Level Set:</p>
<ul>
<li>Number of iterations is the number of deformation steps the model will perform.</li>
<li>Propagation scaling is the weight you assign to model inflation.</li>
<li>Curvature scaling is the weight you assign to model surface regularisation (this will eventually make the model collapse and vanish if it is too large).</li>
<li>Advection scaling regulates the attraction of the surface of the image gradient modulus ridges.</li>
</ul>
<p >Based on our limited experience, we recommended that propagation and curvature should be set to <code>0.0</code>, and advection to <code>1.0</code>. The number of iterations should be set large enough for the level set not to move anymore (if the region is not too big, try with <code>300</code>). We encourage you to experiment with these parameters yourself.</p>
<p >Therefore, enter: </p><div class="fragment"><div class="line">300 0 0 1</div>
</div><!-- fragment --><p >The level set will then evolve until the maximum number of iterations is reached. Then the render window will activate, displaying the final model.</p>
<div class="image">
<img src="curvature0x0.gif" alt=""/>
</div>
 <p >To quit the render window press <code>q</code> or <code>e</code> as usual.</p>
<p >You will then be asked: </p><div class="fragment"><div class="line">Accept result? (y/n)</div>
</div><!-- fragment --><p >If you are not satisfied with your final model, enter <code>n</code> to go back to the level set parameter question. Otherwise, enter <code>y</code>.</p>
<p >Let us assume we are not satisfied, therefore enter <code>n</code>. You will then go back to:</p>
<div class="fragment"><div class="line">Please input parameters (type <span class="keywordflow">return</span> to accept current values, <span class="charliteral">&#39;e&#39;</span> to</div>
<div class="line">end, <span class="charliteral">&#39;q&#39;</span> to quit):</div>
<div class="line"> NumberOfIterations(0) [PropagationScaling(1.0) CurvatureScaling(0.0) </div>
<div class="line">AdvectionScaling(0.0)]:</div>
</div><!-- fragment --><p >Try again with a bigger curvature scaling: </p><div class="fragment"><div class="line">300 0 0.5 1</div>
</div><!-- fragment --><p >This yields the following surface:</p>
<div class="image">
<img src="curvature0x05.gif" alt=""/>
</div>
 <p >To quit the render window press <code>q</code> or <code>e</code> as usual.</p>
<p >You will then be asked once again: </p><div class="fragment"><div class="line">Accept result? (y/n)</div>
</div><!-- fragment --><p >Assuming we are now satisfied, we enter <code>y</code> .</p>
<p >Next, we receive the prompt: </p><div class="fragment"><div class="line">Merge branch? (y/n)</div>
</div><!-- fragment --><p >If you are (still) satisfied with this final model, enter <code>y</code> and this branch will be merged with any branches you segmented before. Otherwise, enter <code>n</code> and this branch will be discarded. (<b>Important:</b> Since this is our first branch we enter <code>y</code> even though no previous branches exist yet!)</p>
<p >The render window will activate, showing you the merged result. To quit the render window press <code>q</code> or <code>e</code> as usual.</p>
<p >Then you will be prompted with: </p><div class="fragment"><div class="line">Segment another branch? (y/n)</div>
</div><!-- fragment --><p >If you want to segment another branch enter <code>y</code>, otherwise enter <code>n</code>.</p>
<p >Let's segment another branch and enter <code>y</code>. You will go back to : </p><div class="fragment"><div class="line">Please choose initialization type: (0: colliding fronts; 1: fast</div>
<div class="line">marching; 2: threshold; 3: isosurface)</div>
</div><!-- fragment --><p >Exactly the same procedure as described above can be used again. Start by placing your two seeds:</p>
<div class="image">
<img src="seed4.gif" alt=""/>
</div>
 <p >This yields the following deformable model:</p>
<div class="image">
<img src="deformable_model2.gif" alt=""/>
</div>
 <p >Deform it as before, until you reach the final model:</p>
<div class="image">
<img src="curvature1x05.gif" alt=""/>
</div>
 <p >Then when you merge the branches, we obtain this:</p>
<div class="image">
<img src="merge_branches.gif" alt=""/>
</div>
 <p >Continue until you have segmented all branches. In our case, we have three branches (we are extracting the surface model of an iliac bifurcation). The final result is:</p>
<div class="image">
<img src="merge_branches2.gif" alt=""/>
</div>
 <p >Now you have a file named <code>level_sets.vti</code> which contains an image. The zero level of this image is the surface you generated. Now we <br  />
 extract a polygonal surface from it with : </p><div class="fragment"><div class="line">vmtkmarchingcubes -ifile level_sets.vti -ofile model.vtp</div>
</div><!-- fragment --><p >The final surface model is <code>model.vtp</code> which you can display with : </p><div class="fragment"><div class="line">vmtksurfacereader -ifile model.vtp --pipe vmtksurfaceviewer</div>
</div><!-- fragment --><div class="image">
<img src="surfaceviewer1.gif" alt=""/>
</div>
 <div class="image">
<img src="surfaceviewer2.gif" alt=""/>
</div>
 <p >We note that you can add further branches to the <code>level_sets.vti</code> file by using the command</p>
<div class="fragment"><div class="line"> vmtklevelsetsegmentation -ifile image_volume_voi.vti -levelsetsfile \</div>
<div class="line">level_sets.vti -ofile level_sets2.vti</div>
</div><!-- fragment --><hr  />
 <hr  />
<h2><a class="anchor" id="smooth"></a>
Smoothing the surface</h2>
<p >At this point, we have our surface model and we want to generate a computational mesh. In most cases, the surface model has bumpy surfaces, especially if the image quality is not high and if we didn't use the curvature term in the level set evolution. Artificial bumps in the surface can result in spurious flow features and will affect the wall shear stress distribution, so one may want to increase surface smoothness before building the mesh.</p>
<p >You can do this in VMTK with : </p><div class="fragment"><div class="line"> vmtksurfacesmoothing -ifile model.vtp -passband 0.1 -iterations 30 \</div>
<div class="line">-ofile model_sm.vtp</div>
</div><!-- fragment --><p >There are two parameters controlling the amount of smoothing: passband, which is the cut-off spatial frequency of the low pass filter, and iterations, which is the number of smoothing passes.</p>
<p >For typical vessels, a passband of 0.1 and a number of iteration of 30 should be OK. For example, for the surface model obtained in the section <a class="el" href="index.html#surface">The 3D surface reconstruction of a vascular segment</a> above, the resulting surface is:</p>
<div class="image">
<img src="smooth0130.gif" alt=""/>
</div>
 <p >Remember that we can display the surfaces with : </p><div class="fragment"><div class="line">vmtksurfacereader -ifile model_sm.vtp --pipe vmtksurfaceviewer</div>
</div><!-- fragment --><p >Smoothing with a passband of 0.01 turns this into:</p>
<div class="image">
<img src="smooth00130.gif" alt=""/>
</div>
 <p >If you want more smoothing, you can increase the passband and/or the number of iterations, but be careful not to remove all surface features by smoothing too much. Also, watch the apex of bifurcations since its curvature may decrease resulting in a shallower apex, affecting the simulated haemodynamics. For example, with a passband of <code>0.001</code> and a number of iterations of <code>100</code>, the result is:</p>
<div class="image">
<img src="smooth0001100.gif" alt=""/>
</div>
 <hr  />
 <hr  />
<h2><a class="anchor" id="clip"></a>
Clipping the endcaps</h2>
<p >Once we have created our smooth model, the next step is to open the inlets and outlets, as they are normally closed with a blobby appearance. We proceed by clipping the blobby endcaps with:</p>
<div class="fragment"><div class="line">vmtksurfaceclipper -ifile model_sm.vtp -ofile model_cl.vtp</div>
</div><!-- fragment --><p >When the render window pops up, pressing <code>i</code> will activate the "interactor". A cube will appear (as in <code>vmtkimagevoiselector</code> in the section <a class="el" href="index.html#voi">Volume of interest</a>). Position the cube in such a way that the portion of the surface you want to clip lies inside the cube.</p>
<div class="image">
<img src="clip0.gif" alt=""/>
</div>
 <p >Press the space bar to proceed with clipping.</p>
<div class="image">
<img src="clip1.gif" alt=""/>
</div>
 <p >Press i again if you want to clip another piece, or q if you want to quit.</p>
<p >The final result should look like this:</p>
<div class="image">
<img src="clip2.gif" alt=""/>
</div>
 <p >Note that it is possible to clip the endcaps automatically with VMTK. For more information, please refer to VMTK's own <a href="http://www.vmtk.org">tutorial pages</a>.</p>
<hr  />
 <hr  />
<h2><a class="anchor" id="add_extensions"></a>
Adding flow extensions</h2>
<p >VMTK provides the option to generate cylindrical extensions to the inlet and outlet cross-sections. These are typically used to ensure that in the numerical simulation, the boundary conditions are applied at a reasonable distance from the region of interest and do not have a strong effect on the flow field. Exactly what sort of boundary conditions to apply and where to apply them is, of course, a non-trivial problem. Nonetheless, the appropriate VMTK command to add the cylindrical extensions is:</p>
<div class="fragment"><div class="line">vmtksurfacereader -ifile model_cl.vtp --pipe vmtkcenterlines \</div>
<div class="line">-seedselector openprofiles --pipe vmtkflowextensions -adaptivelength 1 \</div>
<div class="line">-extensionratio 8 -normalestimationratio 1 -interactive 0 --pipe \</div>
<div class="line">vmtksurfacewriter -ofile model_ex.vtp</div>
</div><!-- fragment --><p >where the control parameters are:</p>
<ul>
<li><code>adaptivelength</code> (here set to 1) is a boolean flag. If set to 1, the length of each flow extension is made proportional to the mean radius of the vessel</li>
<li><code>extensionratio</code> (here set to 8) is the proportionality factor of the length of each flow extension.</li>
<li><code>normalestimationratio:</code> We suggest setting this parameter to 1. For further information, please refer to VMTK's <a href="http://www.vmtk.org">tutorial page</a>.</li>
<li>The flag <code>-interactive</code> was set to <code>0</code>: This means that <code>vmtkflowextensions</code> will not prompt the user about what inlet or outlet to extend, but it will perform the task on all the available open boundaries. If you use <code>-interactive</code> <code>1</code>, VMTK prompts the user to specify which boundaries to extend through a graphical window.</li>
</ul>
<p >When the render window pops up, before pressing <code>q</code>, make sure you note the different ids of the inlets and outlets. For our example, we see in the figure below that we have one inlet with an id 0 and two outlets with the ids 1 and 2.</p>
<div class="image">
<img src="extension1.gif" alt=""/>
</div>
 <p >A message will appear on your terminal: </p><div class="fragment"><div class="line">Please input list of inlet profile ids:</div>
</div><!-- fragment --><p >Enter the list of ids with a space between them. In our example enter <code>0</code> . Next you will receive: </p><div class="fragment"><div class="line">Please input list of outlet profile ids:</div>
</div><!-- fragment --><p >Enter the list of ids with a space separating them. In our example enter: </p><div class="fragment"><div class="line">1 2</div>
</div><!-- fragment --><p >You can display the resulting surface using: </p><div class="fragment"><div class="line">vmtksurfacereader -ifile model_ex.vtp --pipe vmtksurfaceviewer</div>
</div><!-- fragment --><p >The result is:</p>
<div class="image">
<img src="extenstion_display.gif" alt=""/>
</div>
 <hr  />
 <hr  />
<h2><a class="anchor" id="vmtk_mesh"></a>
The mesh generation</h2>
<p >Finally, we can generate our mesh using the command line: </p><div class="fragment"><div class="line">vmtkmeshgenerator -ifile model_ex.vtp -ofile mesh.vtu -edgelength 0.5</div>
</div><!-- fragment --><p >where the edgelength parameter expresses the nominal edge length of a surface triangle, in physical units. Note that the surface remeshing may fail if you specify a large edge length.</p>
<hr  />
 <hr  />
 <h1><a class="anchor" id="oomph_mesh"></a>
Creating an oomph-lib mesh based on output files generated by VMTK</h1>
<p >VMTK exports the mesh for different solvers. The one we chose is the ".xda" format (of <a href="http://libmesh.sourceforge.net/">LibMesh</a>). To export the mesh in this format enter:</p>
<div class="fragment"><div class="line"> vmtkmeshwriter -ifile mesh.vtu -entityidsarray CellEntityIds -ofile \</div>
<div class="line">iliac.xda</div>
</div><!-- fragment --><p ><code>oomph-lib</code> provides a conversion code </p><div class="fragment"><div class="line">bin/<a class="code hl_function" href="create__fluid__and__solid__surface__mesh__from__fluid__xda__mesh_8cc.html#acaf73fcb31e5c25107e81bf28bb52d4c">create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh</a></div>
<div class="ttc" id="acreate__fluid__and__solid__surface__mesh__from__fluid__xda__mesh_8cc_html_acaf73fcb31e5c25107e81bf28bb52d4c"><div class="ttname"><a href="create__fluid__and__solid__surface__mesh__from__fluid__xda__mesh_8cc.html#acaf73fcb31e5c25107e81bf28bb52d4c">create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh</a></div><div class="ttdeci">void create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh(const std::string &amp;file_name, const std::string &amp;fluid_surface_file, const std::string &amp;solid_surface_file, const double &amp;wall_tickness, const bool &amp;do_multi_boundary_ids=true)</div><div class="ttdoc">This driver code takes as input the mesh generated by VMTK in '.xda' format.</div><div class="ttdef"><b>Definition:</b> <a href="create__fluid__and__solid__surface__mesh__from__fluid__xda__mesh_8cc_source.html#l00086">create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh.cc:86</a></div></div>
</div><!-- fragment --><p >which uses the VMTK output mesh in "*.xda" format to generate a file "fluid_*.poly" that can be used to generate the fluid mesh using the open-source mesh generator <a href="http://wias-berlin.de/software/tetgen//">TetGen</a>.</p>
<p >When executing the conversion code you will be prompted with: </p><div class="fragment"><div class="line">Please enter the file name without the file extension <span class="stringliteral">&#39;.xda&#39;</span>:</div>
</div><!-- fragment --><p >In our example, enter <code>iliac</code> .</p>
<p >To facilitate the simulation of physiological fluid-structure interaction problems in which the vessel walls deform elastically in response to the fluid traction, the conversion code also generates a file "solid_*.poly" that can be used to to generate a mesh for the 3D vessel wall which is assumed to be of constant thickness.</p>
<p >The conversion code therefore requests the wall thickness:</p>
<div class="fragment"><div class="line">Enter the (uniform) wall thickness</div>
</div><!-- fragment --><p >As explained in <a href="../../../interaction/unstructured_three_d_fsi/html/index.html">another tutorial</a>, the consistent generation of surface coordinates in FSI problems requires that all faces with the same boundary ID should be co-planar. For this reason the conversion code provides the option to assign a distinct boundary ID to each surface triangle on the fluid-structure interaction boundary and ensures the IDs are consistent for the fluid and the solid meshes. (The "*.poly" files generated by the conversion code list the relation between the old and boundary IDs at the end.)</p>
<div class="fragment"><div class="line">Do you want to create a separate ID <span class="keywordflow">for each</span> planar facet</div>
<div class="line">on the fluid-structure interaction boundary?</div>
<div class="line">Enter y or n: </div>
</div><!-- fragment --><p >For single-physics problem, however, it is much easier to assign a single boundary ID to each "physical" surface (<em> i.e. </em> inlet, outlet, vessel boundary). Assuming that we are solving such a single-physics problem we enter <code>n</code>. Two files are now generated : <code>fluid_iliac.poly</code> which contains the fluid domain and <code>solid_iliac.poly</code> containing the solid one.</p>
<p ><a href="http://wias-berlin.de/software/tetgen//tetview.html">Tetgen's</a> mesh viewer <code>tetview</code> can now be used to display the surface meshes: </p><div class="fragment"><div class="line">tetview fluid_iliac.poly</div>
</div><!-- fragment --><p> displays the fluid surface mesh with its four boundaries</p>
<div class="image">
<img src="fluid1.gif" alt=""/>
</div>
  <div class="image">
<img src="fluid2.gif" alt=""/>
</div>
 <p >While </p><div class="fragment"><div class="line">tetview fluid_iliac.poly</div>
</div><!-- fragment --><p> displays the solid surface mesh (for a wall thickness of 2mm):</p>
<div class="image">
<img src="solid1.gif" alt=""/>
</div>
  <div class="image">
<img src="solid2.gif" alt=""/>
</div>
 <hr  />
<p >If multiple boundary IDs are requested, the surface meshes are:</p>
<div class="image">
<img src="fluid_mult_ids.gif" alt=""/>
<div class="caption">
The fluid surface with multiple boundary IDs </div></div>
 <div class="image">
<img src="solid_mult_ids.gif" alt=""/>
<div class="caption">
The solid surface with multiple boundary IDs for a wall thickness of 2mm </div></div>
 <hr  />
 <hr  />
<h1><a class="anchor" id="comm_and_ex"></a>
Comments and Exercises</h1>
<ul>
<li>In its current form, the conversion code <center> <a href="../../../../demo_drivers/meshing/mesh_from_vmtk/create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh.cc">demo_drivers/interaction/create_fluid_and_solid_surface_mesh_from_fluid_xda_mesh.cc</a> </center> is restricted to bifurcation-like geometries, and makes certain assumptions about the enumeration of the boundaries. Furthermore, it can only deal with constant thickness vessel walls: the outer surface of the blood vessel is assumed to be parallel to the FSI interface, with the wall thickness being measured in the direction normal to that interface. This simplistic construction can easily create overlapping elements if the apex of the bifurcation is highly curved and/or if a large wall thickness is requested. If this happens tetgen will be unable to generate the solid mesh. It should be easy to modify the code to deal with such cases, however. <a href="../../../contact/html/index.html">Get in touch</a> if you need help with this (and feel free to share any improvements with us).</li>
<li>We provide three separate tutorials to demonstrate the use of VMTK-based meshes in <code>oomph-lib</code> driver codes:<ul>
<li><a href="../../../solid/vmtk_solid/html/index.html">The inflation of the arterial bifurcation by a constant pressure &ndash; a pure solid mechanics problem.</a></li>
<li><a href="../../../navier_stokes/vmtk_fluid/html/index.html">Steady finite-Reynolds number flow through the (rigid) arterial bifurcation &ndash; a pure fluid-mechanics mechanics problem.</a></li>
<li><a href="../../../interaction/vmtk_fsi/html/index.html">Steady finite-Reynolds-number flow through an elastic arterial bifurcation &ndash; a fluid-structure interaction problem.</a></li>
</ul>
</li>
<li>To facilitate experimentation with the methodology we distribute the <br  />
 <code>xda</code> file that was used to create the meshes in the above examples. It is available at: <center> <a href="../../../../demo_drivers/interaction/vmtk_fsi/iliac.xda">demo_drivers/interaction/vmtk_fsi/iliac.xda</a> </center></li>
</ul>
<hr  />
 <hr  />
 <h1><a class="anchor" id="pdf"></a>
PDF file</h1>
<p >A <a href="../latex/refman.pdf">pdf version</a> of this document is available. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->

    <!-- jQuery for Bootstrap and Doxygen -->
    <script src="../../../js/jquery-1.12.0.min.js"></script>
    <!-- Minified boostrap plugins-->
    <script src="../../../js/bootstrap.js"></script>
    <!-- Doxygen dependency to add powertips to source code-->
    <script src="../../../js/jquery.powertip.min.js"></script>
    <!-- The  following script is generated by doxygen and hides/shows levels in 
         the data structure lists and adds powertips to source code-->
    <script src="../../../js/dynsections.js" ></script>
    <!-- add to Doxygen's class names so bootstrap css and js recognises them-->
    <script type="text/javascript">
    $(".contents").addClass("container");
    $(".header").addClass("container");
    $(".navpath").addClass("container");
    $("#navrow3").addClass("container");
    $("#navrow4").addClass("container");
    $(".mlabel").addClass("label");
    $(".mlabel").addClass("label-default");
    $(".memitem").addClass("panel");
    $(".memitem").addClass("panel-info");
    $(".memproto").addClass("panel-heading");
    $(".memdoc").addClass("panel-body");
    </script>
    <footer>
      <div class="container">
        <div class="text-muted" style="float:right;">Generated by <a href="http://www.doxygen.org/index.html">
          <img style="height:18px;" class="footer-img" src="doxygen.png" alt="doxygen"></a> on Tue Nov 2 2021 16:27:51
        </div>
      </div>
    </footer>
</body>
</html>
