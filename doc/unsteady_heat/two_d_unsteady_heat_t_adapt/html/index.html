<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>oomph-lib: Example problem: Solution of the 2D unsteady heat equation with temporal adaptivity</title>
<link rel="apple-touch-icon" sizes="57x57" href="../../../figures/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../../../figures/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../../../figures/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../../../figures/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../../../figures/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../../../figures/apple-touch-icon-120x120.png">
<link rel="icon" type="image/png" href="../../../figures/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../figures/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../figures/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="../../../figures/manifest.json">
<link rel="mask-icon" href="../../../figures/safari-pinned-tab.svg" color="#008000">
<link rel="shortcut icon" href="../../../figures/favicon.ico">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-config" content="../../../figures/browserconfig.xml">
<meta name="theme-color" content="#008000">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600" rel="stylesheet" type="text/css">
<!-- Doxygen css-->
<!-- <link rel="stylesheet" type="text/css" href="doxygen.css"> -->
<!-- Bootstrap -->
<link href="../../../css/bootstrap.css" rel="stylesheet">
<!-- oomph-lib specific overrides -->
<link rel="stylesheet" type="text/css" href="../../../css/oomph_header.css">
</head>
<body>
<nav class="navbar navbar-default">
<div class="container">
<div class="container-fluid">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="../../../html/index.html"><img alt="oomph-lib" src="../../../figures/oomph_logo.png"></a>
  </div>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">          
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Big picture</li>
          <li><a href="../../../../doc/intro/html/index.html">The finite element method</a></li>
          <li><a href="../../../../doc/the_data_structure/html/index.html">The data structure</a></li>
          <li><a href="../../../../doc/quick_guide/html/index.html">Not-so-quick guide</a></li>
          <li><a href="../../../../doc/optimisation/html/index.html">Optimisation</a></li>
          <li><a href="../../../../doc/order_of_action_functions/html/index.html">Order of action functions</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Example codes and tutorials</li>
          <li><a href="../../../../doc/example_code_list/html/index.html">List of example codes and tutorials</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#meshes">Meshing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#solvers">Solvers</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#parallel">MPI parallel processing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#visualisation">Post-processing/visualisation</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Other</li>
          <li><a href="../../../../doc/change_log/html/index.html">Change log</a></li>
          <li><a href="../../../../doc/creating_doc/html/index.html">Creating documentation</a></li>
          <li><a href="../../../../doc/coding_conventions/html/index.html">Coding conventions</a></li>
          <li><a href="../../../../doc/index/html/index.html">Index</a></li>
          <li><a href="../../../../doc/FAQ/html/index.html">FAQ</a></li>
        </ul>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Installation<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/the_distribution/html/index.html">Installation guide</a></li>
            <li><a href="../../../../doc/copyright/html/index.html">Copyright</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/people/html/index.html">People</a></li>            
            <li><a href="../../../../doc/contact/html/index.html">Contact/Get involved</a></li>
            <li><a href="../../../../doc/publications/html/index.html">Publications</a></li>
            <li><a href="../../../../doc/acknowledgements/html/index.html">Acknowledgements</a></li>
            <li><a href="../../../../doc/picture_show/index.html">Picture show</a></li>
          </ul>
        </li>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right navbar-search">
      <form class="navbar-form" role="search" action="../../../../doc/search_results/html/index.html">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search" name="q">
          <span class="input-group-btn">
            <button class="btn btn-default" type="submit">Go</button>
          </span>
        </div><!-- /input-group -->
       <!--<div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>-->
      </form>
    </ul>
  </div><!-- /.navbar-collapse -->
</div><!-- /.container-fluid -->
</div>
</nav>
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Example problem: Solution of the 2D unsteady heat equation with temporal adaptivity </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This example illustrates <code>oomph-lib's</code> adaptive timestepping capabilities. We consider, yet again, the 2D unsteady heat equation </p><center> <table class="doxtable">
<tr>
<td><center> <b>The two-dimensional unsteady heat equation in a square domain.</b> </center> Solve <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{i=1}^2\frac{\partial^2 u}{\partial x_i^2} = \frac{\partial u}{\partial t} + f\left(x_1,x_2,t\right), \ \ \ \ \ \ \ \ \ \ (1) \]" src="form_0.png" width="216" height="38"/>
</p>
 in the square domain <img class="formulaInl" alt="$ D = \{x_i \in [0,1]; i=1,2 \} $" src="form_1.png" width="135" height="14"/>, subject to the Dirichlet boundary conditions <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \left. u\right|_{\partial D}=g_0 \ \ \ \ \ \ \ \ \ \ (2) \]" src="form_2.png" width="110" height="14"/>
</p>
 and initial conditions <p class="formulaDsp">
<img class="formulaDsp" alt="\[ u(x_1,x_2,t=0)=h_0(x_1,x_2), \ \ \ \ \ \ \ \ \ \ (3) \]" src="form_3.png" width="214" height="14"/>
</p>
 where the functions <img class="formulaInl" alt="$ g_0$" src="form_4.png" width="13" height="9"/> and <img class="formulaInl" alt="$ h_0$" src="form_5.png" width="13" height="13"/> are given.   </td></tr>
</table>
<br  />
 </center><p>Here we choose the forcing function and the boundary and initial conditions so that </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ u_0(x_1,x_2,t) = \frac{1}{2} \bigg( 1 + \tanh\big(\gamma \cos(2\pi t)\big)\bigg) \sin\left(K \left( x_1 \cos \Phi + x_2 \sin \Phi\right)\right), \ \ \ \ \ \ \ \ \ \ (4) \]" src="form_6.png" width="429" height="31"/>
</p>
<p> is the exact solution. The solution represents a 1D sin profile with wavenumber <img class="formulaInl" alt="$ K $" src="form_7.png" width="11" height="10"/>, rotated against the <img class="formulaInl" alt="$x_1$" src="form_8.png" width="13" height="9"/>-axis by an angle <img class="formulaInl" alt="$ \Phi $" src="form_9.png" width="9" height="10"/>, and modulated by a time-periodically varying amplitude. The parameter <img class="formulaInl" alt="$ \gamma $" src="form_10.png" width="9" height="9"/> controls the rate at which the amplitude changes. For large <br  />
 values of <img class="formulaInl" alt="$ \gamma $" src="form_10.png" width="9" height="9"/>, the amplitude remains constant for most of the period but changes rapidly at <img class="formulaInl" alt="$ t = \left( 1/4 + i/2 \right), i=0,1,2,... $" src="form_11.png" width="156" height="14"/>. To resolve these rapid changes accurately, very small timesteps are required. Conversely, relatively large timesteps could be employed during the phases when the solution remains approximately constant. The problem therefore presents an ideal test case for an adaptive timestepping scheme.</p>
<p>The figure below shows a snapshot from the <a href="../figures/unsteady_heat_soln.avi">animation of the exact and computed solutions,</a> obtained from a simulation with <code>oomph-lib's</code> adaptive <code>BDF&lt;2&gt;</code> timestepper. Since the time interval between subsequent frames in this animation varies, each frame shows a blue line (in the top left corner) whose length is proportional to the elapsed time. The different rate at which the length of the line increases reflects the fact that smaller timesteps are taken when the solution varies rapidly.</p>
<div class="image">
<img src="unsteady_heat_soln.gif" alt=""/>
<div class="caption">
Snapshot from the animation of the exact and computed solutions. </div></div>
 <p>The figure below shows the time trace of the solution and documents the timesteps chosen by the adaptive timestepping scheme. Note how smaller timesteps are chosen when the solution undergoes rapid changes.</p>
<div class="image">
<img src="trace.gif" alt=""/>
<div class="caption">
Upper plot: Time evolution of the computed and exact solutions at a control node. Lower plot: The timestep dt and the norm of the error. </div></div>
 <p>Most of the driver code for this example is identical to that discussed in the <a href="../../two_d_unsteady_heat/html/index.html">previous example,</a> therefore we only discuss the modifications required to enable temporal adaptivity:</p><ul>
<li>We pass a boolean flag to the constructor of the <code>BDF&lt;2&gt;</code> timestepper.</li>
<li>We define a global error norm for the adaptive timestepper by overloading the (empty) virtual function <code>Problem::global_temporal_error_norm()</code>.</li>
<li>We replace the call to <code>Problem::unsteady_newton_solve(...)</code> by a call to <code>Problem::adaptive_unsteady_newton_solve(...)</code> and specify a target for the temporal error norm. <br  />
</li>
</ul>
<hr  />
 <hr  />
<h1><a class="anchor" id="namespace"></a>
Global parameters and functions</h1>
<p>We store the problem parameters and define the source function and the exact solution in the usual namespace.</p>
 <div class="fragment"><div class="line"><span class="comment">//======start_of_ExactSolnForUnsteadyHeat=====================</span></div>
<div class="line"><span class="comment">/// Namespace for forced exact solution for UnsteadyHeat equation </span></div>
<div class="line"><span class="comment"></span><span class="comment">//====================================================================</span></div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespaceExactSolnForUnsteadyHeat.html">ExactSolnForUnsteadyHeat</a></div>
<div class="line">{</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Factor controlling the rate of change</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>=10.0;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Wavenumber</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>=3.0;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Angle of bump</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>=1.0; </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Exact solution as a Vector</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a1d5b22857bd2a7825397daf1cf9c89eb">get_exact_u</a>(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; time, <span class="keyword">const</span> Vector&lt;double&gt;&amp; x, </div>
<div class="line">                  Vector&lt;double&gt;&amp; u)</div>
<div class="line"> {</div>
<div class="line">  <span class="keywordtype">double</span> zeta=cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[0]+sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[1];</div>
<div class="line">  u[0]=sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*zeta)*</div>
<div class="line">       0.5*(1.0+tanh(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*cos(2.0*MathematicalConstants::Pi*time)));</div>
<div class="line"> }</div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Exact solution as a scalar</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a1d5b22857bd2a7825397daf1cf9c89eb">get_exact_u</a>(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; time, <span class="keyword">const</span> Vector&lt;double&gt;&amp; x, <span class="keywordtype">double</span>&amp; u)</div>
<div class="line"> {</div>
<div class="line">  <span class="keywordtype">double</span> zeta=cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[0]+sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[1];</div>
<div class="line">  u=sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*zeta)*</div>
<div class="line">       0.5*(1.0+tanh(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*cos(2.0*MathematicalConstants::Pi*time)));</div>
<div class="line"> }</div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Source function to make it an exact solution </span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#ab4e853d6368b1fcdbd6205079687455a">get_source</a>(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; time, <span class="keyword">const</span> Vector&lt;double&gt;&amp; x, <span class="keywordtype">double</span>&amp; source)</div>
<div class="line"> {</div>
<div class="line">  source=</div>
<div class="line">   -0.5*sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*(cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[0]+sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[1]))*<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*pow(cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>),2.0)*(</div>
<div class="line">    0.1E1+tanh(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*cos(0.2E1*0.3141592653589793E1*time)))-</div>
<div class="line">   0.5*sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*(cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[0]+sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[1]))*<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*pow(sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>),2.0)*</div>
<div class="line">   (0.1E1+tanh(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*cos(0.2E1*0.3141592653589793E1*time)))+</div>
<div class="line">   0.1E1*sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">K</a>*(cos(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[0]+sin(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">Phi</a>)*x[1]))*</div>
<div class="line">   (1.0-pow(tanh(<a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*cos(0.2E1*0.3141592653589793E1*time)),2.0))*</div>
<div class="line">   <a class="code" href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">Gamma</a>*sin(0.2E1*0.3141592653589793E1*time)*0.3141592653589793E1;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// end of ExactSolnForUnsteadyHeat</span></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html">ExactSolnForUnsteadyHeat</a></div><div class="ttdoc">//////////////////////////////////////////////////////////////////// ////////////////////////////////...</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00052">two_d_unsteady_heat_t_adapt.cc:53</a></div></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html_a188d3472da738e31efb23740c027754c"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html#a188d3472da738e31efb23740c027754c">ExactSolnForUnsteadyHeat::Gamma</a></div><div class="ttdeci">double Gamma</div><div class="ttdoc">Factor controlling the rate of change.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00056">two_d_unsteady_heat_t_adapt.cc:56</a></div></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html_a1d5b22857bd2a7825397daf1cf9c89eb"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html#a1d5b22857bd2a7825397daf1cf9c89eb">ExactSolnForUnsteadyHeat::get_exact_u</a></div><div class="ttdeci">void get_exact_u(const double &amp;time, const Vector&lt; double &gt; &amp;x, Vector&lt; double &gt; &amp;u)</div><div class="ttdoc">Exact solution as a Vector.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00065">two_d_unsteady_heat_t_adapt.cc:65</a></div></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html_a20d04bcf14546becd4bcdf45446be756"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html#a20d04bcf14546becd4bcdf45446be756">ExactSolnForUnsteadyHeat::K</a></div><div class="ttdeci">double K</div><div class="ttdoc">Wavenumber.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00059">two_d_unsteady_heat_t_adapt.cc:59</a></div></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html_a630f9e8d892cfcc41cdaef25bfc87ca1"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html#a630f9e8d892cfcc41cdaef25bfc87ca1">ExactSolnForUnsteadyHeat::Phi</a></div><div class="ttdeci">double Phi</div><div class="ttdoc">Angle of bump.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00062">two_d_unsteady_heat_t_adapt.cc:62</a></div></div>
<div class="ttc" id="anamespaceExactSolnForUnsteadyHeat_html_ab4e853d6368b1fcdbd6205079687455a"><div class="ttname"><a href="namespaceExactSolnForUnsteadyHeat.html#ab4e853d6368b1fcdbd6205079687455a">ExactSolnForUnsteadyHeat::get_source</a></div><div class="ttdeci">void get_source(const double &amp;time, const Vector&lt; double &gt; &amp;x, double &amp;source)</div><div class="ttdoc">Source function to make it an exact solution.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00082">two_d_unsteady_heat_t_adapt.cc:82</a></div></div>
</div><!-- fragment --><hr  />
 <hr  />
<h1><a class="anchor" id="main"></a>
The driver code</h1>
<p>Temporal adaptivity only requires a few straightforward changes to the time-stepping loop. Since the number of timesteps required to reach the end of the simulation is not known a priori, we replace the <code>for</code> - loop over the fixed number of timesteps, employed in the <a href="../../two_d_unsteady_heat/html/index.html">non-adaptive version of the code,</a> by a <code>while</code> - loop that continues the time-integration until <img class="formulaInl" alt="$ t \ge t_{max}$" src="form_12.png" width="46" height="11"/>.</p>
<p>The adaptive timestepper, <code>Problem::adaptive_unsteady_newton_solve(...)</code> takes two arguments. The first one is a suggestion for the size of the next timestep; the second specifies the target error The adaptive timestepper automatically adjusts the timestep until the error estimate computed by <code>Problem::global_temporal_error_norm()</code> is less than that target. If the error estimate for the solution computed with the suggested value of <code>dt</code> is too large, <code>dt</code> is reduced by a factor of 2 and the solution is recomputed. This process is repeated until</p><ul>
<li>the estimated error has become sufficiently small</li>
</ul>
<p>or</p><ul>
<li><code>dt</code> has been reduced below a threshold.</li>
</ul>
<p>The threshold is stored in the private member data <code>Problem::Minimum_dt</code> and is initialised to <img class="formulaInl" alt="$ 10^{-12} $" src="form_13.png" width="30" height="11"/>. This default can be changed with the access function <code>Problem::minimum_dt()</code>. It is also possible to specify a maximum value for the timestep by overwriting the default value <img class="formulaInl" alt="$ 10^{12} $" src="form_14.png" width="23" height="11"/> for the corresponding data member, <code>Problem::Maximum_dt</code>, using the function <code>Problem::maximum_dt()</code>.</p>
<p>The adaptive unsteady Newton solver returns a suggestion for the size of the next timestep.</p>
<p>Here is the relevant code fragment from the otherwise unchanged <code>main</code> function:</p>
 <div class="fragment"><div class="line"> <span class="comment">// Target error for adaptive timestepping</span></div>
<div class="line"> <span class="keywordtype">double</span> epsilon_t=1.0e-4;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Timestepping loop: Don&#39;t know how many steps we&#39;re going to take</span></div>
<div class="line"> <span class="comment">// in advance</span></div>
<div class="line"> <span class="keywordflow">while</span> (problem.time_pt()-&gt;time()&lt;t_max)</div>
<div class="line">  {</div>
<div class="line">  </div>
<div class="line">   <span class="comment">// Take an adaptive timestep -- the input dt is the suggested timestep.</span></div>
<div class="line">   <span class="comment">// The adaptive timestepper will adjust dt until the required error</span></div>
<div class="line">   <span class="comment">// tolerance is satisfied. The function returns a suggestion</span></div>
<div class="line">   <span class="comment">// for the timestep that should be taken for the next step. This</span></div>
<div class="line">   <span class="comment">// is either the actual timestep taken this time or a larger</span></div>
<div class="line">   <span class="comment">// value if the solution was found to be &quot;too accurate&quot;. </span></div>
<div class="line">   <span class="keywordtype">double</span> dt_next=problem.adaptive_unsteady_newton_solve(dt,epsilon_t);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Use dt_next as suggestion for the next timestep</span></div>
<div class="line">   dt=dt_next;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Output solution</span></div>
<div class="line">   problem.doc_solution(doc_info,trace_file);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">//Increment counter for solutions </span></div>
<div class="line">   doc_info.number()++;</div>
<div class="line"> </div>
<div class="line">  } <span class="comment">// end of timestepping loop</span></div>
</div><!-- fragment --><p> The rest of the main function is identical to that in the <a href="../../two_d_unsteady_heat/html/index.html">previous, non-adaptive example.</a></p>
<hr  />
 <hr  />
<h1><a class="anchor" id="problem"></a>
The problem class</h1>
<p>The problem class contains a single additional member function</p>
 <div class="fragment"><div class="line"> <span class="comment">/// Global error norm for adaptive time-stepping</span></div>
<div class="line"> <span class="keywordtype">double</span> global_temporal_error_norm();</div>
</div><!-- fragment --><p> which we will discuss below.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="constructor"></a>
The problem constructor</h1>
<p>The problem constructor is almost identical to that in the <a href="../../two_d_unsteady_heat/html/index.html">previous example.</a> The only difference is that the boolean flag <code>true</code> is passed to the constructor of the <code>BDF&lt;2&gt;</code> timestepper, which means that a predictor step is computed for each timestep, see <a href="#back">background </a> for more details.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="destructor"></a>
The problem destructor</h1>
<p>The problem destructor is identical to that in the <a href="../../two_d_unsteady_heat/html/index.html">previous example.</a></p>
<hr  />
 <hr  />
<h1><a class="anchor" id="before_timestep"></a>
Actions before timestep</h1>
<p>This function is identical to that in the <a href="../../two_d_unsteady_heat/html/index.html">previous example.</a></p>
<hr  />
 <hr  />
<h1><a class="anchor" id="IC"></a>
Set initial condition</h1>
<p>This function is identical to that in the <a href="../../two_d_unsteady_heat2/html/index.html">previous example.</a></p>
<hr  />
 <hr  />
<h1><a class="anchor" id="doc"></a>
Post-processing</h1>
<p>The Problem member function <code>doc_solution(...)</code> is virtually identical to that in the <a href="../../two_d_unsteady_heat2/html/index.html">previous example.</a> We merely add the timestep <code>dt</code> to the trace file.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="dump"></a>
Dumping the solution</h1>
<p>This function is identical to that in the <a href="../../two_d_unsteady_heat2/html/index.html">previous example,</a> indicating that the generic <code>Problem::dump()</code> function can deal with time-dependent simulations.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="read"></a>
Reading a solution from disk</h1>
<p>This function is identical to that in the <a href="../../two_d_unsteady_heat2/html/index.html">previous example, </a>indicating that the generic <code>Problem::read()</code> function can deal with time-dependent simulations.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="error"></a>
Defining the global error norm for the adaptive timestepper</h1>
<h2><a class="anchor" id="back"></a>
Background</h2>
<p><code>oomph-lib's</code> adaptive timesteppers employ a predictor-corrector scheme to control the size of the timestep. In these schemes a low-order explicit timestepper is used to predict the solution at the next timestep. This prediction is compared to the solution computed with the actual (usually implicit) timestepper itself. The difference between the two predictions is then used to derive an estimate of the error (exploiting the different truncation errors of the two timestepping schemes).</p>
<p>Interfaces to the functions that compute the temporal error estimates are defined as broken virtual function in the <code>TimeStepper</code> base class. Specific <code>TimeSteppers</code> that allow adaptive timestepping <br  />
 therefore overload the broken virtual function</p>
<div class="fragment"><div class="line">TimeStepper::temporal_error_in_value(data_pt,i)</div>
</div><!-- fragment --><p>which computes an estimate of the error of <code>i</code> - th value stored in the <code>Data</code> object pointed to by <code>data_pt</code>. In free-boundary problems in which the position of the nodes is an unknown, the corresponding function</p>
<div class="fragment"><div class="line">TimeStepper::temporal_error_in_position(node_pt,i)</div>
</div><!-- fragment --><p>may be used to obtain an estimate of the error in the <code>i</code> - th nodal coordinate of the <code>Node</code> pointed to by <code>node_pt</code>.</p>
<p>These individual error estimates must be combined into a problem-specific, scalar error norm, <img class="formulaInl" alt="${\cal E}$" src="form_15.png" width="9" height="10"/> say, which forms the basis of the adaptive adjustment of the timestep in <code>Problem::adaptive_unsteady_newton_solve(...)</code>.</p>
<h2><a class="anchor" id="impl"></a>
Implementation</h2>
<p>In the present problem, we choose the RMS of the errors <img class="formulaInl" alt="$ e_j \ (j=1,...,N_{node})$" src="form_16.png" width="106" height="14"/> at the nodes as the global error norm </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ {\cal E} = \sqrt{ \frac{1}{N_{node}} \sum_{j=1}^{N_{node}} e_j^2 }. \]" src="form_17.png" width="119" height="45"/>
</p>
<p> This may be implemented in a few lines of code:</p>
 <div class="fragment"><div class="line"><span class="comment">//========start_of_global_temporal_error_norm==============================</span></div>
<div class="line"><span class="comment">/// Global error norm for adaptive timestepping: RMS error, based on</span></div>
<div class="line"><span class="comment"></span><span class="comment">/// difference between predicted and actual value at all nodes.</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">double</span> <a class="code" href="classUnsteadyHeatProblem.html#a888e25dd97e89d31e485cb188721dbe1">UnsteadyHeatProblem&lt;ELEMENT&gt;::global_temporal_error_norm</a>()</div>
<div class="line">{</div>
<div class="line"> <span class="keywordtype">double</span> global_error = 0.0;</div>
<div class="line">   </div>
<div class="line"> <span class="comment">//Find out how many nodes there are in the problem</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> n_node = mesh_pt()-&gt;nnode();</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Loop over the nodes and calculate the estimated error in the values</span></div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;n_node;i++)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Get error in solution: Difference between predicted and actual</span></div>
<div class="line">   <span class="comment">// value for nodal value 0</span></div>
<div class="line">   <span class="keywordtype">double</span> error = mesh_pt()-&gt;node_pt(i)-&gt;time_stepper_pt()-&gt;</div>
<div class="line">    temporal_error_in_value(mesh_pt()-&gt;node_pt(i),0);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">//Add the square of the individual error to the global error</span></div>
<div class="line">   global_error += error*error;</div>
<div class="line">  }</div>
<div class="line">    </div>
<div class="line"> <span class="comment">// Divide by the number of nodes</span></div>
<div class="line"> global_error /= double(n_node);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Return square root...</span></div>
<div class="line"> <span class="keywordflow">return</span> sqrt(global_error);</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// end of global_temporal_error_norm</span></div>
<div class="ttc" id="aclassUnsteadyHeatProblem_html_a888e25dd97e89d31e485cb188721dbe1"><div class="ttname"><a href="classUnsteadyHeatProblem.html#a888e25dd97e89d31e485cb188721dbe1">UnsteadyHeatProblem::global_temporal_error_norm</a></div><div class="ttdeci">double global_temporal_error_norm()</div><div class="ttdoc">Global error norm for adaptive time-stepping.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__t__adapt_8cc_source.html#l00573">two_d_unsteady_heat_t_adapt.cc:573</a></div></div>
</div><!-- fragment --><hr  />
 <hr  />
<h1><a class="anchor" id="comments"></a>
Comments and Exercises</h1>
<p>As demonstrated above, enabling temporal adaptivity for a given problem is extremely straightforward as it only requires the implementation of the problem-specific function <code>Problem::global_temporal_error_norm()</code>. In most cases, the RMS of the nodal errors (or some suitable generalisation for vector-valued problems) is an obvious choice. In free-boundary problems, the RMS of the error estimate for the nodal positions is often a useful error measure.</p>
<hr  />
<h2><a class="anchor" id="norm"></a>
How to choose the target for the temporal error norm</h2>
<p>Having decided on an error norm, how does one choose the target for the error norm? The answer is the same as in a simulation with a fixed timestep: Trial and error, followed by careful convergence tests. We usually employ the following strategy:</p><ul>
<li>Implement the function <code>Problem::global_temporal_error_norm()</code> and perform an initial computation with a fixed timestep, choosing its size heuristically, exploiting prior knowledge that we (usually!) have about our problem. For instance, if we expect a periodic solution with an approximate period <img class="formulaInl" alt="$ T $" src="form_18.png" width="10" height="9"/>, we may start with a fixed timestep <img class="formulaInl" alt="$ dt = T/20,$" src="form_19.png" width="58" height="14"/> say. The computed results are likely to be very inaccurate but the time-trace will usually reveal the characteristic features of the solution and thus identify phases during which the solution varies rapidly. <br  />
</li>
<li>Now repeat the simulation with a smaller time-step, <img class="formulaInl" alt="$ dt = T/40,$" src="form_20.png" width="58" height="14"/> say, and check if any new features develop in the time-trace. If the time-trace appears to be robust, monitor the temporal error norm, e.g. by including the output of <code>Problem::global_temporal_error_norm()</code> into the trace file.</li>
<li>Use the maximum of the temporal error norm observed during the simulation with the fixed timestep as the target in a first simulation with temporal adaptivity. The timestepper should now increase the size of the timestep in regions where the error estimate was small.</li>
<li>Now repeat the simulation with smaller and smaller target errors until further reductions do not lead to further changes in the computed results.</li>
</ul>
<h3><a class="anchor" id="ex"></a>
Exercise:</h3>
<p>Employ the above procedure to determine the target error <img class="formulaInl" alt="$ \hat{\cal E}$" src="form_21.png" width="9" height="13"/> required for the computed solution to be graphically indistinguishable from that obtained with a target error of <img class="formulaInl" alt="$ \hat{\cal E}/2$" src="form_22.png" width="21" height="16"/>.</p>
<hr  />
<h2><a class="anchor" id="restarts"></a>
Restarting from a simulation with temporal adaptivity</h2>
<p>We mentioned above that the data recorded/read by the generic <code>Problem::dump(...)</code> and <code>Problem::read(...)</code> functions is sufficient to restart a temporally adaptive simulations as the functions record the history values and the history of previous timesteps. Here is an illustration of a simulation that was started from the restart file produced at <img class="formulaInl" alt="$ t=0.175$" src="form_23.png" width="50" height="9"/> in the original run. The solution computed in the restarted run follows that obtained in the original simulation but it does not employ exactly the same timesteps.</p>
<div class="image">
<img src="restart_trace.gif" alt=""/>
<div class="caption">
Time-trace of the solution and the timestep chosen by the adaptive timestepper in the original (green) and restarted (red) simulation. </div></div>
 <h3><a class="anchor" id="ex"></a>
Exercise:</h3>
<p>Explain why the restarted simulation uses slightly different timesteps and modify the <code>dump_it(...)</code> and <code>restart(...)</code> functions to solve this problem. [<b>Hints:</b> <b> (i) </b> Recall that the adaptive timestepper returns a suggestion for the next timestep. This is not recorded in the restart data! <b> (ii) </b> If you can't solve the problem, have a look at the <a href="../../two_d_unsteady_heat_2adapt/html/index.html">discussion of <code>oomph-lib's</code> doubly-adaptive unsteady Newton solver</a> where an improved dump/restart procedure is implemented.]</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="sources"></a>
Source files for this tutorial</h1>
<ul>
<li>The source files for this tutorial are located in the directory: <center> <a href="../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat_t_adapt/">demo_drivers/unsteady_heat/two_d_unsteady_heat_t_adapt/ </a> </center></li>
<li>The driver code is: <center> <a href="../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat_t_adapt/two_d_unsteady_heat_t_adapt.cc">demo_drivers/unsteady_heat/two_d_unsteady_heat_t_adapt/two_d_unsteady_heat_t_adapt.cc </a> </center></li>
</ul>
<hr  />
 <hr  />
 <h1><a class="anchor" id="pdf"></a>
PDF file</h1>
<p>A <a href="../latex/refman.pdf">pdf version</a> of this document is available. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->

    <!-- jQuery for Bootstrap and Doxygen -->
    <script src="../../../js/jquery-1.12.0.min.js"></script>
    <!-- Minified boostrap plugins-->
    <script src="../../../js/bootstrap.js"></script>
    <!-- Doxygen dependency to add powertips to source code-->
    <script src="../../../js/jquery.powertip.min.js"></script>
    <!-- The  following script is generated by doxygen and hides/shows levels in 
         the data structure lists and adds powertips to source code-->
    <script src="../../../js/dynsections.js" ></script>
    <!-- add to Doxygen's class names so bootstrap css and js recognises them-->
    <script type="text/javascript">
    $(".contents").addClass("container");
    $(".header").addClass("container");
    $(".navpath").addClass("container");
    $("#navrow3").addClass("container");
    $("#navrow4").addClass("container");
    $(".mlabel").addClass("label");
    $(".mlabel").addClass("label-default");
    $(".memitem").addClass("panel");
    $(".memitem").addClass("panel-info");
    $(".memproto").addClass("panel-heading");
    $(".memdoc").addClass("panel-body");
    </script>
    <footer>
      <div class="container">
        <div class="text-muted" style="float:right;">Generated by <a href="http://www.doxygen.org/index.html">
          <img style="height:18px;" class="footer-img" src="doxygen.png" alt="doxygen"></a> on Thu Dec 19 2024 11:15:29
        </div>
      </div>
    </footer>
</body>
</html>
