<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>oomph-lib: Example problem: Spatially and temporally adaptive solution of the 2D unsteady heat equation with flux boundary conditions in a moving domain.</title>
<link rel="apple-touch-icon" sizes="57x57" href="../../../figures/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../../../figures/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../../../figures/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../../../figures/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../../../figures/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../../../figures/apple-touch-icon-120x120.png">
<link rel="icon" type="image/png" href="../../../figures/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../figures/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../figures/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="../../../figures/manifest.json">
<link rel="mask-icon" href="../../../figures/safari-pinned-tab.svg" color="#008000">
<link rel="shortcut icon" href="../../../figures/favicon.ico">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-config" content="../../../figures/browserconfig.xml">
<meta name="theme-color" content="#008000">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600" rel="stylesheet" type="text/css">
<!-- Doxygen css-->
<!-- <link rel="stylesheet" type="text/css" href="doxygen.css"> -->
<!-- Bootstrap -->
<link href="../../../css/bootstrap.css" rel="stylesheet">
<!-- oomph-lib specific overrides -->
<link rel="stylesheet" type="text/css" href="../../../css/oomph_header.css">
</head>
<body>
<nav class="navbar navbar-default">
<div class="container">
<div class="container-fluid">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="../../../html/index.html"><img alt="oomph-lib" src="../../../figures/oomph_logo.png"></a>
  </div>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">          
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Big picture</li>
          <li><a href="../../../../doc/intro/html/index.html">The finite element method</a></li>
          <li><a href="../../../../doc/the_data_structure/html/index.html">The data structure</a></li>
          <li><a href="../../../../doc/quick_guide/html/index.html">Not-so-quick guide</a></li>
          <li><a href="../../../../doc/optimisation/html/index.html">Optimisation</a></li>
          <li><a href="../../../../doc/order_of_action_functions/html/index.html">Order of action functions</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Example codes and tutorials</li>
          <li><a href="../../../../doc/example_code_list/html/index.html">List of example codes and tutorials</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#meshes">Meshing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#solvers">Solvers</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#parallel">MPI parallel processing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#visualisation">Post-processing/visualisation</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Other</li>
          <li><a href="../../../../doc/change_log/html/index.html">Change log</a></li>
          <li><a href="../../../../doc/creating_doc/html/index.html">Creating documentation</a></li>
          <li><a href="../../../../doc/coding_conventions/html/index.html">Coding conventions</a></li>
          <li><a href="../../../../doc/index/html/index.html">Index</a></li>
          <li><a href="../../../../doc/FAQ/html/index.html">FAQ</a></li>
        </ul>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Installation<span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/the_distribution/html/index.html">Installation guide</a></li>
            <li><a href="../../../../doc/copyright/html/index.html">Copyright</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/people/html/index.html">People</a></li>            
            <li><a href="../../../../doc/contact/html/index.html">Contact/Get involved</a></li>
            <li><a href="../../../../doc/publications/html/index.html">Publications</a></li>
            <li><a href="../../../../doc/acknowledgements/html/index.html">Acknowledgements</a></li>
            <li><a href="../../../../doc/picture_show/index.html">Picture show</a></li>
          </ul>
        </li>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right navbar-search">
      <form class="navbar-form" role="search" action="../../../../doc/search_results/html/index.html">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search" name="q">
          <span class="input-group-btn">
            <button class="btn btn-default" type="submit">Go</button>
          </span>
        </div><!-- /input-group -->
       <!--<div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>-->
      </form>
    </ul>
  </div><!-- /.navbar-collapse -->
</div><!-- /.container-fluid -->
</div>
</nav>
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Example problem: Spatially and temporally adaptive solution of the 2D unsteady heat equation with flux boundary conditions in a moving domain. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is the final and most complex problem in our series of demo codes for the unsteady heat equation. We re-visit the moving domain problem considered in the <a href="../../two_d_unsteady_heat_ALE/html/index.html">previous example </a> and solve it with a <em>combination</em> of spatial and temporal adaptivity.</p>
<center> <table class="doxtable">
<tr>
<td><center> <b>The two-dimensional unsteady heat equation with flux boundary conditions in a moving domain.</b> </center> Solve <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \sum_{i=1}^2\frac{\partial^2 u}{\partial x_i^2} = \frac{\partial u}{\partial t} + f\left(x_1,x_2,t\right), \ \ \ \ \ \ \ \ \ \ (1) \]" src="form_0.png" width="216" height="38"/>
</p>
 in the domain <img class="formulaInl" alt="$ D $" src="form_1.png" width="10" height="10"/>, bounded by the coordinate axes and the time-dependent ellipse <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \mathbf{r}_{ellipse}(\xi,t) = \left( \begin{array}{c} \big(a+\hat{a}\sin(2\pi t/\hat{T})\big) \cos(\xi) \\ \big(b+\hat{b}\sin(2\pi t/\hat{T})\big) \sin(\xi) \end{array} \right), \ \ \ \ \ \ \ \ \ \ (2) \]" src="form_2.png" width="309" height="34"/>
</p>
 subject to Neumann boundary conditions, <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \left. \frac{\partial u}{\partial n}\right|_{\partial D_{Neumann}}= - \left. \frac{\partial u}{\partial x_2}\right|_{\partial D_{Neumann}}= g_0, \ \ \ \ \ \ \ \ \ \ (3) \]" src="form_3.png" width="280" height="34"/>
</p>
 along the horizontal domain boundary <img class="formulaInl" alt="$ \partial D_{Neumann} = \{ (x_1,x_2) | x_1 \in [0,1], x_2=0 \} $" src="form_4.png" width="231" height="14"/>, and to Dirichlet boundary conditions, <p class="formulaDsp">
<img class="formulaDsp" alt="\[ \left. u\right|_{\partial D_{Dirichlet}}=h_0, \ \ \ \ \ \ \ \ \ \ (4) \]" src="form_5.png" width="156" height="15"/>
</p>
 elsewhere. <div class="image">
<img src="domain.gif" alt=""/>
<div class="caption">
Sketch of the time-dependent domain and the boundary conditions. </div></div>
  The initial conditions are given by <p class="formulaDsp">
<img class="formulaDsp" alt="\[ u(x_1,x_2,t=0)=k_0(x_1,x_2), \ \ \ \ \ \ \ \ \ \ (5) \]" src="form_6.png" width="213" height="14"/>
</p>
 where the functions <img class="formulaInl" alt="$ f, g_0, \ h_0$" src="form_7.png" width="45" height="13"/> and <img class="formulaInl" alt="$ k_0$" src="form_8.png" width="11" height="13"/> are given.   </td></tr>
</table>
<br  />
 </center><p>We choose the functions <img class="formulaInl" alt="$ f, g_0, \ h_0$" src="form_7.png" width="45" height="13"/> and <img class="formulaInl" alt="$ k_0$" src="form_8.png" width="11" height="13"/> so that </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ u_0(x_1,x_2,t) = \tanh\bigg[1-\alpha\bigg(\tan\Phi \big(x_1-\beta\tanh[ \gamma\cos\left(2\pi t\right)]\big)- x_2\bigg)\bigg] \ \ \ \ \ \ \ \ \ \ (6) \]" src="form_9.png" width="421" height="31"/>
</p>
<p> is the exact solution.</p>
<p>The solution represents the "usual" tanh profile, whose steepness is controlled by the parameter <img class="formulaInl" alt="$ \alpha $" src="form_10.png" width="8" height="6"/> so that for <img class="formulaInl" alt="$ \alpha \gg 1 $" src="form_11.png" width="33" height="10"/> the solution approaches a step. The step is oriented at an angle <img class="formulaInl" alt="$ \Phi $" src="form_12.png" width="9" height="10"/> against the <img class="formulaInl" alt="$ x_1-$" src="form_13.png" width="23" height="9"/>-axis and its position varies periodically. The parameter <img class="formulaInl" alt="$ \beta $" src="form_14.png" width="9" height="13"/> controls the amplitude of the step's lateral displacement, while <img class="formulaInl" alt="$ \gamma $" src="form_15.png" width="9" height="9"/> determines the rate at which its position changes. For <img class="formulaInl" alt="$ \gamma \gg 1$" src="form_16.png" width="34" height="11"/>, the step remains stationary for most of the period and then translates rapidly parallel to the <img class="formulaInl" alt="$ x_1-$" src="form_13.png" width="23" height="9"/>-axis, making this a very challenging problem.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="comb"></a>
Background: Combined spatial and temporal adaptivity</h1>
<p>When <a href="../../two_d_unsteady_heat_ALE/html/index.html">solving the above problem with pure spatial adaptivity,</a> we observed that the error of the computed solution increased noticeably during phases when the "step" moved rapidly through the domain, suggesting that the error is due to the temporal rather than the spatial discretisation. If you attempted the exercises suggested at the end of that demo problem, you will have confirmed this by observing that the error is reduced when the time-integration is performed with a smaller timestep. Since the solution only undergoes rapid changes during short periods of time, the use of temporal adaptivity is highly desirable. Before demonstrating that the combined use of temporal and spatial adaptivity only requires trivial changes to the driver code with purely spatial adaptivity, we briefly comment on the strategy employed by <code>oomph-lib's</code> doubly-adaptive unsteady Newton solver</p>
<div class="fragment"><div class="line">doubly_adaptive_unsteady_newton_solve(dt,epsilon_t,max_adapt,first)</div>
</div><!-- fragment --><p>This Newton solver performs the spatial and temporal adaptations sequentially, as follows:</p><ol type="1">
<li>Given a mesh and the solution on that mesh at time <img class="formulaInl" alt="$ t $" src="form_17.png" width="5" height="9"/>, we first advance the solution to time <img class="formulaInl" alt="$ t + dt$" src="form_18.png" width="31" height="11"/>, adjusting the timestep <img class="formulaInl" alt="$ dt $" src="form_19.png" width="11" height="10"/> until the global temporal error norm computed by <code>Problem::global_temporal_error_norm()</code> falls below the target error specified by the (<code>double</code>) argument <code>epsilon_t</code>. The (<code>double</code>) argument <code>dt</code>, specifies the suggestion for the timestep.</li>
<li>Once a temporally accurate solution has been computed on that mesh, we perform up to <code>max_adapt</code> spatial adaptations to reduce the spatial error. We re-compute the solution on the adapted meshes, using the (fixed) timestep selected previously by the temporal adaptation. Once the spatial adaptations are complete, we could, in principle, re-evaluate the temporal error and, if required, re-compute the timestep yet again &ndash; at a significant additional cost. We omit this further adjustment and accept the solution "as is".</li>
</ol>
<p>As before, the boolean argument <code>first</code> indicates if the first timestep is being computed (see the <br  />
 <a href="../../two_d_unsteady_heat_adapt/html/index.html">example without temporal adaptivity</a> for more information on this important issue). As in the <a href="../../two_d_unsteady_heat_t_adapt/html/index.html">case of pure temporal adaptivity</a>, the adaptive unsteady Newton solver returns a suggestion for the size of the next timestep.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="impl"></a>
The implementation</h1>
<p>Since the spatial and temporal adaptations are performed independently, adding "double adaptivity" to the existing <a href="../../two_d_unsteady_heat_ALE/html/index.html">driver code with pure spatial adaptivity</a> only requires the implementation of the additional member function <code>Problem::global_temporal_error_norm()</code>. In the current problem we can use the one that we created for the <a href="../../two_d_unsteady_heat_t_adapt/html/index.html">example with pure temporal adaptivity</a>. Furthermore, we pass a true boolean flag to the constructor of the <code>BDF&lt;2&gt;</code> timestepper, to make it adaptive. That's all! Apart from a few (optional) improvements to the dump/restart functions (discussed below), <a href="../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat_2adapt/two_d_unsteady_heat_2adapt.cc">the code</a> does not require any other changes.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="reslt"></a>
Some results</h1>
<p>The figure below shows a snapshot of the <a href="../figures/step_soln.avi">animated solution</a>, obtained from the doubly adaptive simulation.</p>
<div class="image">
<img src="step_soln.gif" alt=""/>
<div class="caption">
Snapshot of the solution. </div></div>
 <p>When viewing the <a href="../figures/step_soln.avi">animation of the solution</a>, note how the time-bar grows much more rapidly during phases when the solution only changes slowly, reflecting the larger timestep used during these phases.</p>
<p>The time-traces shown below compare the exact and computed solutions, and document the variations in timestep and the norm of the error throughout the simulation, for a temporal error target of <code>epsilon_t</code> = <img class="formulaInl" alt="$ 10^{-2}. $" src="form_20.png" width="29" height="11"/> The plots show clearly how the adaptive timestepper selects a much larger timestep during the phases when the solution only changes slowly. However, the error during phases of rapid change is still relatively large &ndash; the comparison between the exact and computed solution shows that the two are not graphically indistinguishable. We ought to do better!</p>
<div class="image">
<img src="trace.gif" alt=""/>
<div class="caption">
Time trace of the solution, the error and the timestep chosen by the adaptive timestepper for a temporal error target of 1E-2. </div></div>
 <p>The time-traces below show the results from a second simulation with a smaller target error of <code>epsilon_t</code> = <img class="formulaInl" alt="$ 10^{-3} $" src="form_21.png" width="25" height="11"/>. The exact and computed solutions are now graphically indistinguishable and the error has been reduced significantly &ndash; at the cost of having to take much smaller timesteps throughout the simulation. Without adaptive time-stepping, this simulation would become <em>very</em> expensive as timesteps as small as <img class="formulaInl" alt="$ dt = 2 \times 10^{-4}$" src="form_22.png" width="74" height="11"/> are required to properly resolve the solution during the phases of rapid change.</p>
<div class="image">
<img src="trace_target1e-3.gif" alt=""/>
<div class="caption">
Time trace of the solution, the error and the timestep chosen by the adaptive timestepper for a temporal error target of 1E-3. </div></div>
 <hr  />
 <hr  />
<h1><a class="anchor" id="comments"></a>
Comments and Exercises</h1>
<h2><a class="anchor" id="cust"></a>
Customising the dump/restart procedure</h2>
<p>In two earlier examples, we commented on two undesirable features of the default dump/restart procedures:</p><ul>
<li>The restart files do not record the counter (stored in a <code>DocInfo</code> object) that we typically use to label the output files. Therefore the output files produced in the restarted run start with label "0", making it difficult to merge the data files from the original and restarted simulations.</li>
<li>In an adaptive simulation, the restart files do not record the adaptive timestepper's suggestion for the next timestep, therefore the first timestep in the restarted simulation is performed with the timestep that was used when the solution was dumped to disk, leading to slight differences in the history of the timesteps chosen; see the plot shown at the end of the discussion of the <a href="../../two_d_unsteady_heat_t_adapt/html/index.html">example with purely temporal adaptivity. </a></li>
</ul>
<p>To address these problems, we modified the <code>Problem</code> class for the present example slightly: We added the <code>DocInfo</code> object which stores the label for the output file to the <code>Problem's</code> private member data, and provide storage for the size of the next timestep suggested by the adaptive timestepper.</p>
<p> <br  />
 </p><div class="fragment"><div class="line"><span class="keyword">private</span>:</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Doc info object</span></div>
<div class="line"><span class="comment"></span> DocInfo Doc_info;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Suggestion for next timestep (stored to allow it to be written</span></div>
<div class="line"><span class="comment"> /// to (or read from) restart file)</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> Next_dt;</div>
</div><!-- fragment --><p> [We also provide a public access function, <code>double</code> <code>next_dt()</code>, to the suggested next timestep; see <a class="el" href="index.html#no_pub">Do NOT use public member data in any classes</a> .]</p>
<p>We initialise the output label in the <code>Problem</code> constructor,</p>
<p> <br  />
 </p><div class="fragment"><div class="line"><span class="comment">//========start_of_constructor============================================</span></div>
<div class="line"><span class="comment">/// Constructor for UnsteadyHeat problem on deformable ellipse domain.</span></div>
<div class="line"><span class="comment"></span><span class="comment">/// Pass pointer to source function.</span></div>
<div class="line"><span class="comment"></span><span class="comment">//========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><a class="code" href="classRefineableUnsteadyHeatProblem.html#a894f3bd6c1c23c307a736de6898e4e98">RefineableUnsteadyHeatProblem&lt;ELEMENT&gt;::RefineableUnsteadyHeatProblem</a>(</div>
<div class="line"> UnsteadyHeatEquations&lt;2&gt;::UnsteadyHeatSourceFctPt source_fct_pt)</div>
<div class="line"> : Source_fct_pt(source_fct_pt)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Setup labels for output</span></div>
<div class="line"> <span class="comment">//------------------------</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Output directory</span></div>
<div class="line"> Doc_info.set_directory(<span class="stringliteral">&quot;RESLT&quot;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Output number</span></div>
<div class="line"> Doc_info.number()=0; </div>
<div class="ttc" id="aclassRefineableUnsteadyHeatProblem_html_a894f3bd6c1c23c307a736de6898e4e98"><div class="ttname"><a href="classRefineableUnsteadyHeatProblem.html#a894f3bd6c1c23c307a736de6898e4e98">RefineableUnsteadyHeatProblem::RefineableUnsteadyHeatProblem</a></div><div class="ttdeci">RefineableUnsteadyHeatProblem(UnsteadyHeatEquations&lt; 2 &gt;::UnsteadyHeatSourceFctPt source_fct_pt)</div><div class="ttdoc">Constructor: Pass pointer to source function and timestep.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__2adapt_8cc_source.html#l00324">two_d_unsteady_heat_2adapt.cc:324</a></div></div>
</div><!-- fragment --><p> and set <code>Next_dt</code> to the initial timestep when the initial condition is assigned in <code>set_initial_condition()</code>:</p>
<p> <br  />
 </p><div class="fragment"><div class="line">   <span class="comment">// Choose initial timestep</span></div>
<div class="line">   <span class="keywordtype">double</span> dt0=0.005;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Initialise timestep -- also sets the weights for all timesteppers</span></div>
<div class="line">   <span class="comment">// in the problem.</span></div>
<div class="line">   initialise_dt(dt0);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Use this as the first &quot;suggested&quot; timestep</span></div>
<div class="line">   Next_dt=dt0;</div>
</div><!-- fragment --><p>We modify the timestepping loop so that the adaptive timestepper's suggestion for the next timestep is stored in the <code>Problem's</code> private data member <code>Next_dt</code>, which is accessible via the public member function <code>next_dt()</code>:</p>
<p> <br  />
 </p><div class="fragment"><div class="line"> <span class="comment">// Timestepping loop</span></div>
<div class="line"> <span class="keywordflow">while</span> (problem.time_pt()-&gt;time()&lt;t_max)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Take timestep with temporal and spatial adaptivity</span></div>
<div class="line">   <span class="keywordtype">double</span> dt_new=</div>
<div class="line">   problem.doubly_adaptive_unsteady_newton_solve(dt,problem.epsilon_t(),</div>
<div class="line">                                                 max_adapt,first);</div>
<div class="line">   cout &lt;&lt; <span class="stringliteral">&quot;Suggested new dt: &quot;</span> &lt;&lt; dt_new &lt;&lt; std::endl;</div>
<div class="line">   dt=dt_new;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Store for restart</span></div>
<div class="line">   problem.next_dt()=dt_new;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Now we&#39;ve done the first timestep -- don&#39;t re-set the IC</span></div>
<div class="line">   <span class="comment">// in subsequent steps</span></div>
<div class="line">   first=<span class="keyword">false</span>;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Reduce the number of spatial adaptations to one per </span></div>
<div class="line">   <span class="comment">// timestep -- too scared that the interpolation error will </span></div>
<div class="line">   <span class="comment">// wipe out any further gains...</span></div>
<div class="line">   max_adapt=1;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">//Output solution</span></div>
<div class="line">   problem.doc_solution();</div>
<div class="line"> </div>
<div class="line">  }</div>
</div><!-- fragment --><p> Since the <code>Problem</code> now has access to the <code>DocInfo</code> object (and therefore to the label that we use to identify the output files), and to the suggested next timestep, we write both to the restart file, adding brief comments behind the "raw" data.</p>
<p> <br  />
 </p><div class="fragment"><div class="line"><span class="comment">//=======start_of_dump_it=================================================</span></div>
<div class="line"><span class="comment">/// Dump the solution to disk</span></div>
<div class="line"><span class="comment"></span><span class="comment">//========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="classRefineableUnsteadyHeatProblem.html#a1fb939c3f9c258fd49328bb1516ced98">RefineableUnsteadyHeatProblem&lt;ELEMENT&gt;::dump_it</a>(ofstream&amp; dump_file)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Write step number</span></div>
<div class="line"> dump_file &lt;&lt; Doc_info.number() &lt;&lt; <span class="stringliteral">&quot; # step number&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Write suggested next timestep</span></div>
<div class="line"> dump_file &lt;&lt; Next_dt &lt;&lt; <span class="stringliteral">&quot; # suggested next timestep&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Dump the refinement pattern and the generic problem data</span></div>
<div class="line"> Problem::dump(dump_file);</div>
<div class="line">  </div>
<div class="line">} <span class="comment">// end of dump_it</span></div>
<div class="ttc" id="aclassRefineableUnsteadyHeatProblem_html_a1fb939c3f9c258fd49328bb1516ced98"><div class="ttname"><a href="classRefineableUnsteadyHeatProblem.html#a1fb939c3f9c258fd49328bb1516ced98">RefineableUnsteadyHeatProblem::dump_it</a></div><div class="ttdeci">void dump_it(ofstream &amp;dump_file)</div><div class="ttdoc">Dump problem data to allow for later restart.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__2adapt_8cc_source.html#l00996">two_d_unsteady_heat_2adapt.cc:996</a></div></div>
</div><!-- fragment --><p>These values are then read during the restart:</p>
<p> <br  />
 </p><div class="fragment"><div class="line"><span class="comment">//=========start_of_restart===============================================</span></div>
<div class="line"><span class="comment">/// Read solution from disk</span></div>
<div class="line"><span class="comment"></span><span class="comment">//========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="classRefineableUnsteadyHeatProblem.html#af36fa71e72852367411e21b50b179625">RefineableUnsteadyHeatProblem&lt;ELEMENT&gt;::restart</a>(ifstream&amp; restart_file)</div>
<div class="line">{</div>
<div class="line"> <span class="comment">// Read line up to termination sign</span></div>
<div class="line"> <span class="keywordtype">string</span> input_string;</div>
<div class="line"> getline(restart_file,input_string,<span class="charliteral">&#39;#&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Ignore rest of line</span></div>
<div class="line"> restart_file.ignore(80,<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Read in step number</span></div>
<div class="line"> Doc_info.number()=unsigned(atof(input_string.c_str()));</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Increment number for next solution</span></div>
<div class="line"> Doc_info.number()++;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Read line up to termination sign</span></div>
<div class="line"> getline(restart_file,input_string,<span class="charliteral">&#39;#&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Ignore rest of line</span></div>
<div class="line"> restart_file.ignore(80,<span class="charliteral">&#39;\n&#39;</span>);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Read suggested next timestep</span></div>
<div class="line"> Next_dt=double(atof(input_string.c_str()));</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Refine the mesh and read in the generic problem data</span></div>
<div class="line"> Problem::read(restart_file);</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// end of restart</span></div>
<div class="ttc" id="aclassRefineableUnsteadyHeatProblem_html_af36fa71e72852367411e21b50b179625"><div class="ttname"><a href="classRefineableUnsteadyHeatProblem.html#af36fa71e72852367411e21b50b179625">RefineableUnsteadyHeatProblem::restart</a></div><div class="ttdeci">void restart(ifstream &amp;restart_file)</div><div class="ttdoc">Read problem data for restart.</div><div class="ttdef"><b>Definition:</b> <a href="two__d__unsteady__heat__2adapt_8cc_source.html#l01014">two_d_unsteady_heat_2adapt.cc:1014</a></div></div>
</div><!-- fragment --><p> [The slightly clumsy read procedure is required to ensure that the comments that follow the "raw" data are ignored.]</p>
<p>Following the assignment of the initial conditions, the first timestep for the timestepping loop in the <code>main</code> function can now be obtained from <code>next_dt()</code> since <code>Next_dt</code> will either have been set to the actual first timestep used when setting up the initial conditions at time <img class="formulaInl" alt="$ t=0$" src="form_23.png" width="29" height="9"/>, or to the next timestep that had been suggested by the adaptive timestepper when the restart file was created.</p>
<p>Here are the time-traces for the solution and the timesteps from the original and the restarted simulations &ndash; apart from the (very small) roundoff errors due to the finite precision in which all data is recorded in the restart files, they are now in perfect agreement.</p>
<div class="image">
<img src="restart_trace.gif" alt=""/>
<div class="caption">
Time-traces of the solution and the timestep for the original (green) and restarted (red) simulations with the customised dump/restart procedure. </div></div>
 <hr  />
<h2><a class="anchor" id="no_pub"></a>
Do NOT use public member data in any classes</h2>
<p>A little aside: Yes, we really do recommend storing the suggestion for the size of the next timestep as private member data and providing an access function to it. This must seem like (and indeed is) slight overkill in the present context: Why can't we just store it as public member data and avoid having to write the access function? The answer is: Because public data is bad and it's a good habit to avoid it as a matter of principle &ndash; even in trivial examples.</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="sources"></a>
Source files for this tutorial</h1>
<ul>
<li>The source files for this tutorial are located in the directory: <center> <a href="../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat_2adapt/">demo_drivers/unsteady_heat/two_d_unsteady_heat_2adapt/ </a> </center></li>
<li>The driver code is: <center> <a href="../../../../demo_drivers/unsteady_heat/two_d_unsteady_heat_2adapt/two_d_unsteady_heat_2adapt.cc">demo_drivers/unsteady_heat/two_d_unsteady_heat_2adapt/two_d_unsteady_heat_2adapt.cc </a> </center></li>
</ul>
<hr  />
 <hr  />
 <h1><a class="anchor" id="pdf"></a>
PDF file</h1>
<p>A <a href="../latex/refman.pdf">pdf version</a> of this document is available. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->

    <!-- jQuery for Bootstrap and Doxygen -->
    <script src="../../../js/jquery-1.12.0.min.js"></script>
    <!-- Minified boostrap plugins-->
    <script src="../../../js/bootstrap.js"></script>
    <!-- Doxygen dependency to add powertips to source code-->
    <script src="../../../js/jquery.powertip.min.js"></script>
    <!-- The  following script is generated by doxygen and hides/shows levels in 
         the data structure lists and adds powertips to source code-->
    <script src="../../../js/dynsections.js" ></script>
    <!-- add to Doxygen's class names so bootstrap css and js recognises them-->
    <script type="text/javascript">
    $(".contents").addClass("container");
    $(".header").addClass("container");
    $(".navpath").addClass("container");
    $("#navrow3").addClass("container");
    $("#navrow4").addClass("container");
    $(".mlabel").addClass("label");
    $(".mlabel").addClass("label-default");
    $(".memitem").addClass("panel");
    $(".memitem").addClass("panel-info");
    $(".memproto").addClass("panel-heading");
    $(".memdoc").addClass("panel-body");
    </script>
    <footer>
      <div class="container">
        <div class="text-muted" style="float:right;">Generated by <a href="http://www.doxygen.org/index.html">
          <img style="height:18px;" class="footer-img" src="doxygen.png" alt="doxygen"></a> on Thu Dec 19 2024 11:16:13
        </div>
      </div>
    </footer>
</body>
</html>
