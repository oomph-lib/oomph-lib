<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>oomph-lib: The Bretherton problem: An air finger propagates into a 2D channel</title>
<link rel="apple-touch-icon" sizes="57x57" href="../../../figures/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../../../figures/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../../../figures/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../../../figures/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../../../figures/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../../../figures/apple-touch-icon-120x120.png">
<link rel="icon" type="image/png" href="../../../figures/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../../figures/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../../figures/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="../../../figures/manifest.json">
<link rel="mask-icon" href="../../../figures/safari-pinned-tab.svg" color="#008000">
<link rel="shortcut icon" href="../../../figures/favicon.ico">
<meta name="msapplication-TileColor" content="#00a300">
<meta name="msapplication-config" content="../../../figures/browserconfig.xml">
<meta name="theme-color" content="#008000">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600" rel="stylesheet" type="text/css">
<!-- Doxygen css-->
<!-- <link rel="stylesheet" type="text/css" href="doxygen.css"> -->
<!-- Bootstrap -->
<link href="../../../css/bootstrap.css" rel="stylesheet">
<!-- oomph-lib specific overrides -->
<link rel="stylesheet" type="text/css" href="../../../css/oomph_header.css">
</head>
<body>
<nav class="navbar navbar-default">
<div class="container">
<div class="container-fluid">
  <!-- Brand and toggle get grouped for better mobile display -->
  <div class="navbar-header">
    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
      <span class="sr-only">Toggle navigation</span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="../../../html/index.html"><img alt="oomph-lib" src="../../../figures/oomph_logo.png"></a>
  </div>
  <!-- Collect the nav links, forms, and other content for toggling -->
  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
    <ul class="nav navbar-nav">          
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Documentation <span class="caret"></span></a>
        <ul class="dropdown-menu">
          <li class="dropdown-header">Big picture</li>
          <li><a href="../../../../doc/intro/html/index.html">The finite element method</a></li>
          <li><a href="../../../../doc/the_data_structure/html/index.html">The data structure</a></li>
          <li><a href="../../../../doc/quick_guide/html/index.html">Not-so-quick guide</a></li>
          <li><a href="../../../../doc/optimisation/html/index.html">Optimisation</a></li>
          <li><a href="../../../../doc/order_of_action_functions/html/index.html">Order of action functions</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Example codes and tutorials</li>
          <li><a href="../../../../doc/example_code_list/html/index.html">List of example codes and tutorials</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#meshes">Meshing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#solvers">Solvers</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#parallel">MPI parallel processing</a></li>
          <li><a href="../../../../doc/example_code_list/html/index.html#visualisation">Post-processing/visualisation</a></li>
          <li role="separator" class="divider"></li>
          <li class="dropdown-header">Other</li>
          <li><a href="../../../../doc/change_log/html/index.html">Change log</a></li>
          <li><a href="../../../../doc/creating_doc/html/index.html">Creating documentation</a></li>
          <li><a href="../../../../doc/coding_conventions/html/index.html">Coding conventions</a></li>
          <li><a href="../../../../doc/index/html/index.html">Index</a></li>
          <li><a href="../../../../doc/FAQ/html/index.html">FAQ</a></li>
        </ul>
        <li class="dropdown">
          <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">About <span class="caret"></span></a>
          <ul class="dropdown-menu">
            <li><a href="../../../../doc/people/html/index.html">People</a></li>            
            <li><a href="../../../../doc/contact/html/index.html">Contact/Get involved</a></li>
            <li><a href="../../../../doc/publications/html/index.html">Publications</a></li>
            <li><a href="../../../../doc/acknowledgements/html/index.html">Acknowledgements</a></li>
            <li><a href="../../../../doc/copyright/html/index.html">Copyright</a></li>
            <li><a href="../../../../doc/picture_show/index.html">Picture show</a></li>
          </ul>
        </li>
      </li>
    </ul>
    <ul class="nav navbar-nav navbar-right navbar-search">
      <form class="navbar-form" role="search" action="../../../../doc/search_results/html/index.html">
        <div class="input-group">
          <input type="text" class="form-control" placeholder="Search" name="q">
          <span class="input-group-btn">
            <button class="btn btn-default" type="submit">Go</button>
          </span>
        </div><!-- /input-group -->
       <!--<div class="form-group">
          <input type="text" class="form-control" placeholder="Search">
        </div>
        <button type="submit" class="btn btn-default">Submit</button>-->
      </form>
    </ul>
  </div><!-- /.navbar-collapse -->
</div><!-- /.container-fluid -->
</div>
</nav>
<!-- Generated by Doxygen 1.9.8 -->
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">The Bretherton problem: An air finger propagates into a 2D channel </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This tutorial discusses the solution of the classical Bretherton problem in which an air-finger is driven steadily into a 2D fluid-filled, rigid-walled channel.</p>
<p>The driver code listed below was originally developed as a test-bed for the paper</p>
<center> Hazel, A.L. &amp; Heil, M. (2008) The influence of gravity on the steady propagation of a semi-infinite bubble into a flexible channel. Physics of Fluids 20, 092109 <a href="http://www.maths.manchester.ac.uk/~mheil/MATTHIAS/PDF/HazelHeilPoF2008.pdf">(pdf reprint)</a> </center><p>in which we studied the elastic-walled equivalent, paying particular attention to the effect of transverse gravity which plays quite an important role in this problem.</p>
<p>Compared to other tutorials, there is no detailed discussion of the driver code itself because the implementation is somewhat messy. However, given that the driver code is (of course!) very well documented you should be able to figure out what's going on once you've read through the discussion of the problem formulation and our brief comments on the <a class="el" href="index.html#implement">Implementation</a>. <a href="../../../contact/html/index.html">Get in touch</a> if you need more information.</p>
<h1><a class="anchor" id="problem"></a>
The problem</h1>
<p>The sketch below shows the problem setup: An (inviscid) air finger propagates at a steady speed <img class="formulaInl" alt="$ U $" src="form_0.png" width="10" height="10"/> into a 2D rigid-walled, fluid-filled channel of half-width <img class="formulaInl" alt="$ H_0^* $" src="form_1.png" width="16" height="14"/>. In the process it displaces some of the viscous fluid (of density <img class="formulaInl" alt="$ \rho $" src="form_2.png" width="8" height="9"/>, viscosity <img class="formulaInl" alt="$ \mu $" src="form_3.png" width="9" height="9"/> and surface tension <img class="formulaInl" alt="$ \sigma^* $" src="form_4.png" width="13" height="10"/>) and deposits a film of thickness <img class="formulaInl" alt="$ h_0^* $" src="form_5.png" width="13" height="14"/> on the channel walls. [Note that, for the sake of simplicity, we ignore the effect of transverse gravity in this discussion; the driver code listed below allows the specification of a gravitational body force which will break the up-down symmetry of the solution.]</p>
<div class="image">
<img src="bretherton_sketch.gif" alt=""/>
<div class="caption">
Sketch of the problem setup </div></div>
 <p>We non-dimensionalise the velocities on <img class="formulaInl" alt="$ U $" src="form_0.png" width="10" height="10"/>, the lengths on <img class="formulaInl" alt="$ H_0^* $" src="form_1.png" width="16" height="14"/> and the pressure on the viscous scale, <img class="formulaInl" alt="$ \mu U /
H_0^* $" src="form_6.png" width="40" height="14"/> and solve the problem in a frame moving with the velocity of the finger. The flow is then governed by the non-dimensional Navier-Stokes equations  </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[
Re \ u_j\frac{\partial u_i}{\partial x_j} = -\frac{\partial p}{\partial x_i} + \
\frac{\partial }{\partial x_j }\left( \frac{\partial u_i}{\partial x_j} + \frac{\partial u_j}{\partial x_i}  \right)
\]" src="form_7.png" width="224" height="31"/>
</p>
<p> and the continuity equation  </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[ 
\frac{\partial u_i}{\partial x_i}=0, 
\]" src="form_8.png" width="48" height="29"/>
</p>
<p> where the Reynolds number is defined as <img class="formulaInl" alt="$ Re=U H_0 \rho/\mu $" src="form_9.png" width="78" height="14"/>. On the free fluid surface, whose outer unit normal we denote by <img class="formulaInl" alt="$ {\bf n} $" src="form_10.png" width="8" height="6"/>, the fluid normal velocity vanishes,  </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[
{\bf u} \cdot {\bf n} = 0 \mbox{\ \ \ on the air-liquid interface}.
\]" src="form_11.png" width="201" height="13"/>
</p>
<p> We measure the fluid pressure <img class="formulaInl" alt="$ p $" src="form_12.png" width="8" height="9"/> relative to the bubble pressure <img class="formulaInl" alt="$ p_b $" src="form_13.png" width="11" height="9"/>. Then the dynamic boundary condition implies that  </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[
-p n_i + \left( \frac{\partial u_i}{\partial x_j} + 
\frac{\partial u_j}{\partial x_i} \right) n_j + \frac{1}{Ca} \
\kappa_f n_i  = 0
\mbox{\ \ \ on the air-liquid interface,}
\]" src="form_14.png" width="378" height="31"/>
</p>
<p> where <img class="formulaInl" alt="$ \kappa_f = \kappa_f^* H_0 $" src="form_15.png" width="59" height="16"/> is the non-dimensional interface curvature and the capillary number <img class="formulaInl" alt="$ Ca = U\mu/\sigma^* $" src="form_16.png" width="69" height="14"/> is a non-dimensional measure of the bubble velocity. The no-slip condition on the channel walls requires that <img class="formulaInl" alt="$ {\bf
u}=(-1,0) $" src="form_17.png" width="61" height="14"/> at <img class="formulaInl" alt="$ x_2=\pm 1 $" src="form_18.png" width="46" height="11"/>. Far behind the bubble tip, the fluid remains stationary on the walls. In the moving frame of reference, this corresponds to the plug flow profile <img class="formulaInl" alt="$ {\bf u}=(-1,0) $" src="form_19.png" width="61" height="14"/> as <img class="formulaInl" alt="$
x_1\to -\infty $" src="form_20.png" width="55" height="10"/>. The residual film thickness <img class="formulaInl" alt="$ h_0 $" src="form_21.png" width="13" height="13"/> has to be determined as part of the solution and it determines the volume flux through the system. The Poiseuille velocity profile far ahead of the bubble tip,  </p><p class="formulaDsp">
<img class="formulaDsp" alt="\[
{\bf u}=(-1+\frac{3}{2}(1-h_0)(1-x_2^2),0) \mbox{\ \ \ as $ x_1\to \infty$,}
\ \ \ \ \ \ \ \ (1)
\]" src="form_22.png" width="299" height="26"/>
</p>
<p> is then determined by overall continuity. <br  />
</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="results"></a>
Some results</h1>
<p>Here are some pretty pictures of the computed flow field,</p>
<div class="image">
<img src="bretherton_flow_with_streamlines.gif" alt=""/>
<div class="caption">
Velocity and pressure fields </div></div>
 <p>and here is a comparison of the computational predictions for the bubble pressure and film thickness against Bretherton's famous asymptotic predictions (valid only for small capillary numbers!):</p>
<div class="image">
<img src="bretherton_trace.gif" alt=""/>
<div class="caption">
Bubble pressure and film thickness far behind the finger tip vs. capillary number; computed solution and Bretherton's predictions for small Ca. </div></div>
 <hr  />
 <hr  />
<h1><a class="anchor" id="implement"></a>
Implementation</h1>
<p>The discretisation of the problem is reasonably straightforward, the most (human-)time-consuming part being the creation of the spine mesh, discussed in <a href="../../../navier_stokes/spine_channel/html/index.html">another tutorial</a>. The real complication arises from the fact that the application of the "inflow condition" (1) at the right end of the domain &ndash; superficially a Dirichlet condition for the velocity &ndash; depends on the non-dimensional film thickness <img class="formulaInl" alt="$ h_0 $" src="form_21.png" width="13" height="13"/> at the left end of the domain. This introduces a non-local interaction between these degrees of freedom. We handle this by providing a templated wrapper class <code><a class="el" href="classBrethertonElement.html" title="&quot;Bretherton element&quot; is a fluid element (of type ELEMENT) for which the (inflow) velocity at those no...">BrethertonElement</a></code> (templated by the type of the "wrapped" fluid element) which allows the specification of the film thickness as external <code>Data</code> (i.e. <code>Data</code> whose values affect the element's residuals but are not determined by the element; see the discussion of <code>oomph-lib's</code> various types of elemental <code>Data</code> in <a href="../../../the_data_structure/html/index.html">the "bottom up" discussion of the library's data structure</a>). Read the driver code listed below to see how it works!</p>
<hr  />
 <hr  />
<h1><a class="anchor" id="driver"></a>
The driver code</h1>
<div class="fragment"><div class="line"><span class="comment">//LIC// ====================================================================</span></div>
<div class="line"><span class="comment">//LIC// This file forms part of oomph-lib, the object-oriented, </span></div>
<div class="line"><span class="comment">//LIC// multi-physics finite-element library, available </span></div>
<div class="line"><span class="comment">//LIC// at http://www.oomph-lib.org.</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC// Copyright (C) 2006-2026 Matthias Heil and Andrew Hazel</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC// This library is free software; you can redistribute it and/or</span></div>
<div class="line"><span class="comment">//LIC// modify it under the terms of the GNU Lesser General Public</span></div>
<div class="line"><span class="comment">//LIC// License as published by the Free Software Foundation; either</span></div>
<div class="line"><span class="comment">//LIC// version 2.1 of the License, or (at your option) any later version.</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC// This library is distributed in the hope that it will be useful,</span></div>
<div class="line"><span class="comment">//LIC// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div>
<div class="line"><span class="comment">//LIC// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span></div>
<div class="line"><span class="comment">//LIC// Lesser General Public License for more details.</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC// You should have received a copy of the GNU Lesser General Public</span></div>
<div class="line"><span class="comment">//LIC// License along with this library; if not, write to the Free Software</span></div>
<div class="line"><span class="comment">//LIC// Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span></div>
<div class="line"><span class="comment">//LIC// 02110-1301  USA.</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC// The authors may be contacted at oomph-lib@maths.man.ac.uk.</span></div>
<div class="line"><span class="comment">//LIC// </span></div>
<div class="line"><span class="comment">//LIC//====================================================================</span></div>
<div class="line"><span class="comment">// The 2D Bretherton problem</span></div>
<div class="line"><span class="preprocessor">#include&lt;algorithm&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The oomphlib headers   </span></div>
<div class="line"><span class="preprocessor">#include &quot;generic.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;navier_stokes.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;fluid_interface.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// The mesh</span></div>
<div class="line"><span class="preprocessor">#include &quot;meshes/bretherton_spine_mesh.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span>std;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using namespace </span><a class="code hl_namespace" href="namespaceoomph.html">oomph</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">//======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Namepspace for global parameters</span></div>
<div class="line"><span class="comment"></span><span class="comment">//======================================================================</span></div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceGlobal__Physical__Variables.html">Global_Physical_Variables</a></div>
<div class="line">{</div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Reynolds number</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#ab814e627d2eb5bc50318879d19ab16b9">Re</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Womersley = Reynolds times Strouhal</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a085ee4bf968ffdd01a41b8c41864f907">ReSt</a>; </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Product of Reynolds and Froude number</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#aa6286f02b476912dd7550eced538331a">ReInvFr</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Capillary number</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Ca</a>;  </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Direction of gravity</span></div>
<div class="line"><span class="comment"></span> Vector&lt;double&gt; <a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a37a6f46efcb35b4bd12c73f19d741020">G</a>(2);</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to film thickness at outflow on the lower wall</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span>* <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a137bdac2ad4b72a03ec9916e8ee7395b">H_lo_pt</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to film thickness at outflow on the upper wall</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span>* <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a83a3a82f89784013805bd23d63faa7e3">H_up_pt</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to y-position at inflow on the lower wall</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span>* <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a84caa2a64e50ba5b390a3cd100f0f835">Y_lo_pt</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to y-position at inflow on the upper wall</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">double</span>* <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a75878a0c79c88065fd9031f273b62698">Y_up_pt</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Set inflow velocity, based on spine heights at outflow</span></div>
<div class="line"><span class="comment"> /// and channel width at inflow</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a08e9835d71b7f7194ec5475f139211be">inflow</a>(<span class="keyword">const</span> Vector&lt;double&gt;&amp; x, Vector&lt;double&gt;&amp; veloc)</div>
<div class="line"> {</div>
<div class="line"><span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line">  std::ostringstream error_stream;</div>
<div class="line">  <span class="keywordtype">bool</span> throw_error=<span class="keyword">false</span>;</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a137bdac2ad4b72a03ec9916e8ee7395b">H_lo_pt</a>==0) </div>
<div class="line">   {</div>
<div class="line">    error_stream &lt;&lt; <span class="stringliteral">&quot;You must set H_lo_pt\n&quot;</span>;</div>
<div class="line">    throw_error = <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a83a3a82f89784013805bd23d63faa7e3">H_up_pt</a>==0) </div>
<div class="line">   {</div>
<div class="line">    error_stream &lt;&lt; <span class="stringliteral">&quot;You must set H_up_pt\n&quot;</span>;</div>
<div class="line">    throw_error = <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a84caa2a64e50ba5b390a3cd100f0f835">Y_lo_pt</a>==0) </div>
<div class="line">   {</div>
<div class="line">    error_stream &lt;&lt; <span class="stringliteral">&quot;You must set Y_lo_pt\n&quot;</span>;</div>
<div class="line">    throw_error = <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line">  <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a75878a0c79c88065fd9031f273b62698">Y_up_pt</a>==0) </div>
<div class="line">   {</div>
<div class="line">    error_stream &lt;&lt; <span class="stringliteral">&quot;You must set Y_up_pt\n&quot;</span>;</div>
<div class="line">    throw_error = <span class="keyword">true</span>;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">//If one of the errors has occured</span></div>
<div class="line">  <span class="keywordflow">if</span>(throw_error)</div>
<div class="line">   {</div>
<div class="line">    <span class="keywordflow">throw</span> OomphLibError(error_stream.str(),</div>
<div class="line">                        OOMPH_CURRENT_FUNCTION,</div>
<div class="line">                        OOMPH_EXCEPTION_LOCATION);</div>
<div class="line">   }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get average film thickness far ahead</span></div>
<div class="line">  <span class="keywordtype">double</span> h_av=0.5*(*<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a137bdac2ad4b72a03ec9916e8ee7395b">H_lo_pt</a>+*<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a83a3a82f89784013805bd23d63faa7e3">H_up_pt</a>);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get position of upper and lower wall at inflow</span></div>
<div class="line">  <span class="keywordtype">double</span> y_up=*<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a75878a0c79c88065fd9031f273b62698">Y_up_pt</a>;</div>
<div class="line">  <span class="keywordtype">double</span> y_lo=*<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a84caa2a64e50ba5b390a3cd100f0f835">Y_lo_pt</a>;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Constant in velocity profile</span></div>
<div class="line">  <span class="keywordtype">double</span> C =6.0*(2.0*h_av+y_lo-y_up)/</div>
<div class="line">   (y_up*y_up*y_up-y_lo*y_lo*y_lo-h_av*y_up*</div>
<div class="line">    y_up*y_up+h_av*y_lo*y_lo*y_lo-3.0*y_lo*y_up*y_up+</div>
<div class="line">    3.0*y_lo*y_lo*y_up+3.0*y_lo*y_up*y_up*h_av-3.0*y_lo*y_lo*y_up*h_av);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// y coordinate</span></div>
<div class="line">  <span class="keywordtype">double</span> y=x[1];</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Parallel, parabolic inflow</span></div>
<div class="line">  veloc[0]=-1.0+C*(1.0-h_av)*((y_lo-y)*(y_up-y));</div>
<div class="line">  veloc[1]=0.0;</div>
<div class="line"> }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// &quot;Bretherton element&quot; is a fluid element (of type ELEMENT) for which</span></div>
<div class="line"><span class="comment">/// the (inflow) velocity  at those nodes that are located on a </span></div>
<div class="line"><span class="comment">/// specified Mesh boundary is prescribed by Dirichlet boundary </span></div>
<div class="line"><span class="comment">/// conditions. The key is that prescribed velocity profile can be</span></div>
<div class="line"><span class="comment">/// a function of some external Data -- this dependency must</span></div>
<div class="line"><span class="comment">/// be taken into account when computing the element&#39;s Jacobian</span></div>
<div class="line"><span class="comment">/// matrix.</span></div>
<div class="line"><span class="comment">/// </span></div>
<div class="line"><span class="comment">/// This element type is useful, for instance, in the Bretherton</span></div>
<div class="line"><span class="comment">/// problem, where the parabolic &quot;inflow&quot; profile is a function </span></div>
<div class="line"><span class="comment">/// of the film thickness (represented by Spine heights) at the</span></div>
<div class="line"><span class="comment">/// &quot;outflow&quot;.</span></div>
<div class="line"><span class="comment"></span><span class="comment">//======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code hl_class" href="classBrethertonElement.html">BrethertonElement</a> : <span class="keyword">public</span> ELEMENT</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Typedef for pointer (global) function that specifies the</span></div>
<div class="line"><span class="comment"> /// the inflow</span></div>
<div class="line"><span class="comment"></span> <span class="keyword">typedef</span> void (*<a class="code hl_typedef" href="classBrethertonElement.html#a313d868ce6fbd8df07b0360db25133ce">InflowFctPt</a>)(<span class="keyword">const</span> Vector&lt;double&gt;&amp; x, Vector&lt;double&gt;&amp; veloc);</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Constructor: Call the constructor of the underlying element</span></div>
<div class="line"><span class="comment"></span> <a class="code hl_function" href="classBrethertonElement.html#acbc668eed3ea683a67b6b822d6e59974">BrethertonElement</a>() : ELEMENT() {}</div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Activate the dependency of the &quot;inflow&quot; on the external</span></div>
<div class="line"><span class="comment"> /// data. Pass the vector of pointers to the external Data that affects</span></div>
<div class="line"><span class="comment"> /// the inflow, the id of the boundary on which the inflow</span></div>
<div class="line"><span class="comment"> /// condition is to be applied and the function pointer to </span></div>
<div class="line"><span class="comment"> /// to the global function that defines the inflow</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonElement.html#a5a8333b92b4b732e62798c172d7e9d52">activate_inflow_dependency_on_external_data</a>(</div>
<div class="line">  <span class="keyword">const</span> Vector&lt;Data*&gt;&amp; inflow_ext_data,</div>
<div class="line">  <span class="keyword">const</span> <span class="keywordtype">unsigned</span>&amp; inflow_boundary,</div>
<div class="line">  <a class="code hl_typedef" href="classBrethertonElement.html#a313d868ce6fbd8df07b0360db25133ce">InflowFctPt</a> inflow_fct_pt)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Copy data that affects the inflow</span></div>
<div class="line">   <span class="keywordtype">unsigned</span> n_ext=inflow_ext_data.size();</div>
<div class="line">   <a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>.resize(n_ext);</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;n_ext;i++)</div>
<div class="line">    {</div>
<div class="line">     <a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>[i]=inflow_ext_data[i];</div>
<div class="line">    }</div>
<div class="line">   <span class="comment">// Set inflow boundary</span></div>
<div class="line">   <a class="code hl_variable" href="classBrethertonElement.html#a2d3a3d4837d41865d5f62271c98715c5">Inflow_boundary</a>=inflow_boundary;</div>
<div class="line">   <span class="comment">// Set fct pointer to inflow condition</span></div>
<div class="line">   <a class="code hl_variable" href="classBrethertonElement.html#a6ded0faba9d7fcfe96834c56af461977">Inflow_fct_pt</a>=inflow_fct_pt;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Overload assign local equation numbers: Add the dependency </span></div>
<div class="line"><span class="comment"> /// on the external Data that affects the inflow profile</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonElement.html#a40f35d9e03eae08954b6b32badadcf61">assign_local_eqn_numbers</a>(<span class="keyword">const</span> <span class="keywordtype">bool</span>  &amp;store_local_dof_pt)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Call the element&#39;s local equation numbering procedure first</span></div>
<div class="line">   ELEMENT::assign_local_eqn_numbers(store_local_dof_pt);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Now add the equation numbers for the Data that affects the inflow</span></div>
<div class="line">   <span class="comment">// profile</span></div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Number of local equations so far</span></div>
<div class="line">   <span class="keywordtype">unsigned</span> local_eqn_count = this-&gt;ndof();</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Find out max. number of values stored at all Data values </span></div>
<div class="line">   <span class="comment">// that affect the inflow</span></div>
<div class="line">   <span class="keywordtype">unsigned</span> max_nvalue=0;</div>
<div class="line">   <span class="keywordtype">unsigned</span> n_ext=<a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>.size();</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;n_ext;i++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// The external Data:</span></div>
<div class="line">     Data* data_pt=<a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>[i];</div>
<div class="line">     <span class="comment">// Number of values</span></div>
<div class="line">     <span class="keywordtype">unsigned</span> n_val=data_pt-&gt;nvalue();</div>
<div class="line">     <span class="keywordflow">if</span> (n_val&gt;max_nvalue) max_nvalue=n_val;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Allocate sufficient storage</span></div>
<div class="line">   <a class="code hl_variable" href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">Inflow_ext_data_eqn</a>.resize(n_ext,max_nvalue);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">//A local queue to store the global equation numbers</span></div>
<div class="line">   std::deque&lt;unsigned long&gt; global_eqn_number_queue;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Loop over external Data that affect the &quot;inflow&quot;</span></div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;n_ext;i++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// The external Data:</span></div>
<div class="line">     Data* data_pt=<a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>[i];</div>
<div class="line">     </div>
<div class="line">     <span class="comment">// Loop over number of values:</span></div>
<div class="line">     <span class="keywordtype">unsigned</span> n_val=data_pt-&gt;nvalue();</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> ival=0;ival&lt;n_val;ival++)</div>
<div class="line">      {</div>
<div class="line"> </div>
<div class="line">       <span class="comment">// Is it free or pinned?</span></div>
<div class="line">       <span class="keywordtype">long</span> eqn_number=data_pt-&gt;eqn_number(ival);</div>
<div class="line">       <span class="keywordflow">if</span> (eqn_number&gt;=0)</div>
<div class="line">        {</div>
<div class="line">         <span class="comment">// Add global equation number to local storage</span></div>
<div class="line">         global_eqn_number_queue.push_back(eqn_number);</div>
<div class="line">         <span class="comment">// Store local equation number associated with this external dof</span></div>
<div class="line">         <a class="code hl_variable" href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">Inflow_ext_data_eqn</a>(i,ival)=local_eqn_count;</div>
<div class="line">         <span class="comment">// Increment counter for local dofs</span></div>
<div class="line">         local_eqn_count++;</div>
<div class="line">        }</div>
<div class="line">       <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">         <a class="code hl_variable" href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">Inflow_ext_data_eqn</a>(i,ival)=-1;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line">   <span class="comment">//Now add our global equations numbers to the internal element storage</span></div>
<div class="line">   this-&gt;add_global_eqn_numbers(global_eqn_number_queue, </div>
<div class="line">                                GeneralisedElement::Dof_pt_deque);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Overloaded Jacobian computation: Computes the Jacobian</span></div>
<div class="line"><span class="comment"> /// of the underlying element and then adds the FD </span></div>
<div class="line"><span class="comment"> /// operations to evaluate the derivatives w.r.t. the Data values</span></div>
<div class="line"><span class="comment"> /// that affect the inflow.</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonElement.html#ab0bc00d862b2c888703ed38c74f18b77">get_jacobian</a>(Vector&lt;double&gt;&amp; residuals,</div>
<div class="line">                   DenseMatrix&lt;double&gt;&amp; jacobian)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Loop over Data values that affect the inflow</span></div>
<div class="line">   <span class="keywordtype">unsigned</span> n_ext=<a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>.size();</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Call &quot;normal&quot; jacobian first.</span></div>
<div class="line">   ELEMENT::get_jacobian(residuals,jacobian);</div>
<div class="line">   </div>
<div class="line">   <span class="keywordflow">if</span> (n_ext==0) <span class="keywordflow">return</span>;</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Get ready for FD operations</span></div>
<div class="line">   Vector&lt;double&gt; residuals_plus(residuals.size());</div>
<div class="line">   <span class="keywordtype">double</span> fd_step=1.0e-8;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Loop over Data values that affect the inflow</span></div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;n_ext;i++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// Get Data item</span></div>
<div class="line">     Data* data_pt=<a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>[i];</div>
<div class="line">     </div>
<div class="line">     <span class="comment">// Loop over values</span></div>
<div class="line">     <span class="keywordtype">unsigned</span> n_val=data_pt-&gt;nvalue();</div>
<div class="line">     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> ival=0;ival&lt;n_val;ival++)</div>
<div class="line">      {</div>
<div class="line">       <span class="comment">// Local equation number</span></div>
<div class="line">       <span class="keywordtype">int</span> local_eqn=<a class="code hl_variable" href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">Inflow_ext_data_eqn</a>(i,ival);</div>
<div class="line">       </div>
<div class="line">       <span class="comment">// Dof or pinned?</span></div>
<div class="line">       <span class="keywordflow">if</span> (local_eqn&gt;=0)</div>
<div class="line">        {</div>
<div class="line">         <span class="comment">//get pointer to the data value</span></div>
<div class="line">         <span class="keywordtype">double</span> *value_pt = data_pt-&gt;value_pt(ival);</div>
<div class="line"> </div>
<div class="line">         <span class="comment">//Backup Data value</span></div>
<div class="line">         <span class="keywordtype">double</span> backup = *value_pt;</div>
<div class="line">         </div>
<div class="line">         <span class="comment">// Do FD step</span></div>
<div class="line">         *value_pt += fd_step;</div>
<div class="line">         </div>
<div class="line">         <span class="comment">// Re-assign the inflow velocities for nodes in this element</span></div>
<div class="line">         <a class="code hl_function" href="classBrethertonElement.html#a7e655df2ed6104862cc70c2408daf93c">reassign_inflow</a>();</div>
<div class="line">         </div>
<div class="line">                  </div>
<div class="line">         <span class="comment">// Fill in the relevant column in the Jacobian matrix</span></div>
<div class="line">         <span class="keywordtype">unsigned</span> n_dof = this-&gt;ndof();</div>
<div class="line">         <span class="comment">//Zero the residuals</span></div>
<div class="line">         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> idof=0;idof&lt;n_dof;idof++) {residuals_plus[idof] = 0.0;}</div>
<div class="line">         <span class="comment">// Re-compute the element residual</span></div>
<div class="line">         this-&gt;get_residuals(residuals_plus);</div>
<div class="line"> </div>
<div class="line">         <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> idof=0;idof&lt;n_dof;idof++)</div>
<div class="line">          {</div>
<div class="line">           jacobian(idof,local_eqn)=</div>
<div class="line">            (residuals_plus[idof]-residuals[idof])/fd_step;</div>
<div class="line">          }</div>
<div class="line">         </div>
<div class="line">         <span class="comment">//Reset spine height</span></div>
<div class="line">         *value_pt = backup;</div>
<div class="line">         </div>
<div class="line">        }</div>
<div class="line">       <span class="comment">// Note: Re-assignment of inflow is done on the fly during next loop</span></div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Final re-assign for the inflow velocities for nodes in this element</span></div>
<div class="line">   <a class="code hl_function" href="classBrethertonElement.html#a7e655df2ed6104862cc70c2408daf93c">reassign_inflow</a>();</div>
<div class="line">   </div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// For all nodes that are located on specified boundary</span></div>
<div class="line"><span class="comment"> /// re-assign the inflow velocity, using the function pointed to</span></div>
<div class="line"><span class="comment"> /// by the function pointer</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonElement.html#a7e655df2ed6104862cc70c2408daf93c">reassign_inflow</a>()</div>
<div class="line">  { </div>
<div class="line">   <span class="comment">// Loop over all nodes in element -- if they are</span></div>
<div class="line">   <span class="comment">// on inflow boundary, re-assign their velocities</span></div>
<div class="line">   Vector&lt;double&gt; x(2);</div>
<div class="line">   Vector&lt;double&gt; veloc(2);</div>
<div class="line">   <span class="keywordtype">unsigned</span> n_nod = this-&gt;nnode();</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> j=0;j&lt;n_nod;j++)</div>
<div class="line">    {</div>
<div class="line">     Node* nod_pt = this-&gt;node_pt(j);</div>
<div class="line"> </div>
<div class="line">     <span class="keywordflow">if</span>(nod_pt-&gt;is_on_boundary(<a class="code hl_variable" href="classBrethertonElement.html#a2d3a3d4837d41865d5f62271c98715c5">Inflow_boundary</a>))</div>
<div class="line">      {</div>
<div class="line"><span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line">           <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> i=0;i&lt;2;i++)</div>
<div class="line">            {</div>
<div class="line">             <span class="keywordflow">if</span> (nod_pt-&gt;eqn_number(0)&gt;=0)</div>
<div class="line">              {</div>
<div class="line">               std::ostringstream error_stream;</div>
<div class="line">               error_stream </div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;We&#39;re assigning a Dirichlet condition for the &quot;</span> </div>
<div class="line">                &lt;&lt; i &lt;&lt; <span class="stringliteral">&quot;-th &quot;</span></div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;velocity, even though it is not pinned!\n&quot;</span> </div>
<div class="line">                &lt;&lt; <span class="stringliteral">&quot;This can&#39;t be right! I&#39;m bailing out...&quot;</span> </div>
<div class="line">                &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">               <span class="keywordflow">throw</span> OomphLibError(error_stream.str(),</div>
<div class="line">                                   OOMPH_CURRENT_FUNCTION,</div>
<div class="line">                                   OOMPH_EXCEPTION_LOCATION);</div>
<div class="line">              }</div>
<div class="line">            }</div>
<div class="line"><span class="preprocessor">#endif           </span></div>
<div class="line">           <span class="comment">// Get inflow profile </span></div>
<div class="line">           x[0]=nod_pt-&gt;x(0);</div>
<div class="line">           x[1]=nod_pt-&gt;x(1);</div>
<div class="line">           <a class="code hl_variable" href="classBrethertonElement.html#a6ded0faba9d7fcfe96834c56af461977">Inflow_fct_pt</a>(x,veloc);</div>
<div class="line">           nod_pt-&gt;set_value(0,veloc[0]);</div>
<div class="line">           nod_pt-&gt;set_value(1,veloc[1]);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Storage for the external Data that affects the inflow</span></div>
<div class="line"><span class="comment"></span> Vector&lt;Data*&gt; <a class="code hl_variable" href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">Inflow_ext_data</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Storage for the local equation numbers associated the Data</span></div>
<div class="line"><span class="comment"> /// values that affect the inflow</span></div>
<div class="line"><span class="comment"></span> DenseMatrix&lt;int&gt; <a class="code hl_variable" href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">Inflow_ext_data_eqn</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Number of the inflow boundary in the global mesh</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">unsigned</span> <a class="code hl_variable" href="classBrethertonElement.html#a2d3a3d4837d41865d5f62271c98715c5">Inflow_boundary</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Function pointer to the global function that specifies the</span></div>
<div class="line"><span class="comment"> /// inflow velocity profile on the global mesh boundary Inflow_boundary</span></div>
<div class="line"><span class="comment"></span> <a class="code hl_typedef" href="classBrethertonElement.html#a313d868ce6fbd8df07b0360db25133ce">InflowFctPt</a> <a class="code hl_variable" href="classBrethertonElement.html#a6ded0faba9d7fcfe96834c56af461977">Inflow_fct_pt</a>;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Note: Specialisation must go into namespace!</span></div>
<div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespaceoomph.html">oomph</a></div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="comment">//=======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Face geometry of the Bretherton 2D Crouzeix_Raviart spine elements</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;&gt;</div>
<div class="line"><span class="keyword">class </span>FaceGeometry&lt;<a class="code hl_class" href="classBrethertonElement.html">BrethertonElement</a>&lt;SpineElement&lt;QCrouzeixRaviartElement&lt;2&gt; &gt; &gt; &gt;: <span class="keyword">public</span> <span class="keyword">virtual</span> QElement&lt;1,3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line"> FaceGeometry() : QElement&lt;1,3&gt;() {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//=======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Face geometry of the Bretherton 2D Taylor Hood spine elements</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;&gt;</div>
<div class="line"><span class="keyword">class </span>FaceGeometry&lt;<a class="code hl_class" href="classBrethertonElement.html">BrethertonElement</a>&lt;SpineElement&lt;QTaylorHoodElement&lt;2&gt; &gt; &gt; &gt;: <span class="keyword">public</span> <span class="keyword">virtual</span> QElement&lt;1,3&gt;</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line"> FaceGeometry() : QElement&lt;1,3&gt;() {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//=======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Face geometry of the Face geometry of the </span></div>
<div class="line"><span class="comment">///  the Bretherton 2D Crouzeix_Raviart spine elements</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;&gt;</div>
<div class="line"><span class="keyword">class </span>FaceGeometry&lt;FaceGeometry&lt;<a class="code hl_class" href="classBrethertonElement.html">BrethertonElement</a>&lt;</div>
<div class="line"> SpineElement&lt;QCrouzeixRaviartElement&lt;2&gt; &gt; &gt; &gt; &gt;: <span class="keyword">public</span> <span class="keyword">virtual</span> PointElement</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line"> FaceGeometry() : PointElement() {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//=======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Face geometry of face geometry of </span></div>
<div class="line"><span class="comment">/// the Bretherton 2D Taylor Hood spine elements</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;&gt;</div>
<div class="line"><span class="keyword">class </span>FaceGeometry&lt;FaceGeometry&lt;<a class="code hl_class" href="classBrethertonElement.html">BrethertonElement</a>&lt;SpineElement&lt;QTaylorHoodElement&lt;2&gt; &gt; &gt; &gt; &gt;: <span class="keyword">public</span> <span class="keyword">virtual</span> PointElement</div>
<div class="line">{</div>
<div class="line">  <span class="keyword">public</span>:</div>
<div class="line"> FaceGeometry() : PointElement() {}</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></div>
<div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></div>
<div class="line"><span class="comment">/////////////////////////////////////////////////////////////////////</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Bretherton problem</span></div>
<div class="line"><span class="comment"></span><span class="comment">//======================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keyword">class </span><a class="code hl_class" href="classBrethertonProblem.html">BrethertonProblem</a> : <span class="keyword">public</span> Problem</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Constructor: </span></div>
<div class="line"><span class="comment"></span> <a class="code hl_function" href="classBrethertonProblem.html#a207cdfe4cf60e83257e759b1ac15e5eb">BrethertonProblem</a>();</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Spine heights/lengths are unknowns in the problem so their</span></div>
<div class="line"><span class="comment"> /// values get corrected during each Newton step. However,</span></div>
<div class="line"><span class="comment"> /// changing their value does not automatically change the</span></div>
<div class="line"><span class="comment"> /// nodal positions, so we need to update all of them</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#a6a3e76e4900715d8c2fd15d0e350d724">actions_before_newton_convergence_check</a>()</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Update</span></div>
<div class="line">   <a class="code hl_variable" href="classBrethertonProblem.html#af293d72416de7a93ed51f20a5e4fb86e">Bulk_mesh_pt</a>-&gt;node_update();</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Apply inflow on boundary 1</span></div>
<div class="line">   <span class="keywordtype">unsigned</span> ibound=1;</div>
<div class="line">   <span class="keywordtype">unsigned</span> num_nod=mesh_pt()-&gt;nboundary_node(ibound);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Coordinate and velocity</span></div>
<div class="line">   Vector&lt;double&gt; x(2);</div>
<div class="line">   Vector&lt;double&gt; veloc(2);</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Loop over all nodes</span></div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> inod=0;inod&lt;num_nod;inod++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// Get nodal position</span></div>
<div class="line">     x[0]=mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;x(0);</div>
<div class="line">     x[1]=mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;x(1);</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// Get inflow profile</span></div>
<div class="line">     <a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a08e9835d71b7f7194ec5475f139211be">Global_Physical_Variables::inflow</a>(x,veloc);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(0,veloc[0]);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(1,veloc[1]);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Update before solve: empty</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#a7112e0efe4c0cd0269cf47f02df4fe22">actions_before_newton_solve</a>() {}</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Update after solve can remain empty, because the update </span></div>
<div class="line"><span class="comment"> /// is performed automatically after every Newton step.</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#a2e84e3ce784b0f0de5eeefe1175d48ff">actions_after_newton_solve</a>() {}</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Fix pressure value l in element e to value p_value</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#aa4c346d4dc8d7d24147076d281d181e9">fix_pressure</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp;e, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> &amp;l, </div>
<div class="line">                   <span class="keyword">const</span> <span class="keywordtype">double</span> &amp;pvalue)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">//Fix the pressure at that element</span></div>
<div class="line">   <span class="keyword">dynamic_cast&lt;</span>ELEMENT *<span class="keyword">&gt;</span>(<a class="code hl_variable" href="classBrethertonProblem.html#af293d72416de7a93ed51f20a5e4fb86e">Bulk_mesh_pt</a>-&gt;element_pt(e))-&gt;</div>
<div class="line">    <a class="code hl_function" href="classBrethertonProblem.html#aa4c346d4dc8d7d24147076d281d181e9">fix_pressure</a>(l,pvalue);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment"></span></div>
<div class="line"><span class="comment"> /// Activate the dependency of the inflow velocity on the </span></div>
<div class="line"><span class="comment"> /// spine heights at the outflow</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#a04257edfb80f2ff3bf865442d9eb01fb">activate_inflow_dependency</a>();</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Run a parameter study; perform specified number of steps</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#ac24db9373e1a3005e6b14fc92c16b41c">parameter_study</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span>&amp; nsteps); </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Doc the solution</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#ab6e29ecf0dbffabd4ce897203d35626e">doc_solution</a>(DocInfo&amp; doc_info);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">private</span>:</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to control element</span></div>
<div class="line"><span class="comment"></span> ELEMENT* <a class="code hl_variable" href="classBrethertonProblem.html#ab1dfeabf599487ac4a121398c6a98368">Control_element_pt</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Trace file</span></div>
<div class="line"><span class="comment"></span> ofstream <a class="code hl_variable" href="classBrethertonProblem.html#ae37c09c1e0faf5ba8b347fab6a9f687f">Trace_file</a>;</div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Pointer to bulk mesh</span></div>
<div class="line"><span class="comment"></span> BrethertonSpineMesh&lt;ELEMENT,SpineLineFluidInterfaceElement&lt;ELEMENT&gt; &gt;* </div>
<div class="line"> <a class="code hl_variable" href="classBrethertonProblem.html#af293d72416de7a93ed51f20a5e4fb86e">Bulk_mesh_pt</a>;</div>
<div class="line"> </div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//====================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Problem constructor</span></div>
<div class="line"><span class="comment"></span><span class="comment">//====================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><a class="code hl_function" href="classBrethertonProblem.html#a207cdfe4cf60e83257e759b1ac15e5eb">BrethertonProblem&lt;ELEMENT&gt;::BrethertonProblem</a>()</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of elements in the deposited film region</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nx1=24;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of elements in the bottom part of the transition region</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nx2=6;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of elements in channel region</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nx3=12;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of elements in the vertical part of the transition region</span></div>
<div class="line"> <span class="comment">// (=half the number of elements in the liquid filled region ahead</span></div>
<div class="line"> <span class="comment">// of the finger tip)</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nhalf=4;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of elements through thickness of deposited film</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nh=3;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Thickness of deposited film</span></div>
<div class="line"> <span class="keywordtype">double</span> h=0.1;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Create wall geom objects</span></div>
<div class="line"> GeomObject* lower_wall_pt=<span class="keyword">new</span> StraightLine(-1.0);</div>
<div class="line"> GeomObject* upper_wall_pt=<span class="keyword">new</span> StraightLine( 1.0);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Start coordinate on wall</span></div>
<div class="line"> <span class="keywordtype">double</span> xi0=-4.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// End of transition region on wall</span></div>
<div class="line"> <span class="keywordtype">double</span> xi1=1.5;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// End of liquid filled region (inflow) on wall</span></div>
<div class="line"> <span class="keywordtype">double</span> xi2=5.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Now create the mesh</span></div>
<div class="line"> Bulk_mesh_pt = <span class="keyword">new</span>  BrethertonSpineMesh&lt;ELEMENT,</div>
<div class="line">  SpineLineFluidInterfaceElement&lt;ELEMENT&gt; &gt; </div>
<div class="line">  (nx1,nx2,nx3,nh,nhalf,h,lower_wall_pt,upper_wall_pt,xi0,0.0,xi1,xi2);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Make bulk mesh the global mesh</span></div>
<div class="line"> mesh_pt()=Bulk_mesh_pt;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Store the control element</span></div>
<div class="line"> Control_element_pt=Bulk_mesh_pt-&gt;control_element_pt();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set pointers to quantities that determine the inflow profile</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Film thickness at outflow on lower wall:</span></div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a137bdac2ad4b72a03ec9916e8ee7395b">Global_Physical_Variables::H_lo_pt</a>=</div>
<div class="line">  Bulk_mesh_pt-&gt;spine_pt(0)-&gt;spine_height_pt()-&gt;value_pt(0);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Film thickness at outflow on upper wall:</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> last_spine=Bulk_mesh_pt-&gt;nfree_surface_spines()-1;</div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a83a3a82f89784013805bd23d63faa7e3">Global_Physical_Variables::H_up_pt</a>=</div>
<div class="line">  Bulk_mesh_pt-&gt;spine_pt(last_spine)-&gt;spine_height_pt()-&gt;value_pt(0);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Current y-position on lower wall at inflow</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> ibound=1;</div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a84caa2a64e50ba5b390a3cd100f0f835">Global_Physical_Variables::Y_lo_pt</a>=</div>
<div class="line">  Bulk_mesh_pt-&gt;boundary_node_pt(ibound,0)-&gt;x_pt(0,1);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Current y-position on upper wall at inflow</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nnod=Bulk_mesh_pt-&gt;nboundary_node(ibound);</div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a75878a0c79c88065fd9031f273b62698">Global_Physical_Variables::Y_up_pt</a>=</div>
<div class="line">  Bulk_mesh_pt-&gt;boundary_node_pt(ibound,nnod-1)-&gt;x_pt(0,1);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Activate dependency of inflow on spine heights at outflow</span></div>
<div class="line"> activate_inflow_dependency();</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set the boundary conditions for this problem: All nodes are</span></div>
<div class="line"> <span class="comment">// free by default -- just pin the ones that have Dirichlet conditions</span></div>
<div class="line"> <span class="comment">// here</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">// No slip on boundaries 0 1 and 2</span></div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> ibound=0;ibound&lt;=2;ibound++)</div>
<div class="line">  {</div>
<div class="line">   <span class="keywordtype">unsigned</span> num_nod=mesh_pt()-&gt;nboundary_node(ibound);</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> inod=0;inod&lt;num_nod;inod++)</div>
<div class="line">    {</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;pin(0);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;pin(1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Uniform, parallel outflow on boundaries 3 and 5</span></div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> ibound=3;ibound&lt;=5;ibound+=2)</div>
<div class="line">  {</div>
<div class="line">   <span class="keywordtype">unsigned</span> num_nod=mesh_pt()-&gt;nboundary_node(ibound);</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> inod=0;inod&lt;num_nod;inod++)</div>
<div class="line">    {</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;pin(0);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;pin(1);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Pin central spine</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> central_spine=(Bulk_mesh_pt-&gt;nfree_surface_spines()-1)/2;</div>
<div class="line"> Bulk_mesh_pt-&gt;spine_pt(central_spine)-&gt;spine_height_pt()-&gt;pin(0);</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// No slip in moving frame on boundaries 0 and 2</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> ibound=0;ibound&lt;=2;ibound+=2)</div>
<div class="line">  {</div>
<div class="line">   <span class="keywordtype">unsigned</span> num_nod=mesh_pt()-&gt;nboundary_node(ibound);</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> inod=0;inod&lt;num_nod;inod++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// Parallel flow</span></div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(0,-1.0);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(1, 0.0);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">   </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Parallel, uniform outflow on boundaries 3 and 5</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> ibound=3;ibound&lt;=5;ibound+=2)</div>
<div class="line">  {</div>
<div class="line">   <span class="keywordtype">unsigned</span> num_nod=mesh_pt()-&gt;nboundary_node(ibound);</div>
<div class="line">   <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> inod=0;inod&lt;num_nod;inod++)</div>
<div class="line">    {</div>
<div class="line">     <span class="comment">// Parallel inflow</span></div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(0,-1.0);</div>
<div class="line">     mesh_pt()-&gt;boundary_node_pt(ibound,inod)-&gt;set_value(1, 0.0);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">   </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Complete the problem setup to make the elements fully functional</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Loop over the elements in the layer</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> n_bulk=Bulk_mesh_pt-&gt;nbulk();</div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;n_bulk;i++)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">//Cast to a fluid element</span></div>
<div class="line">   ELEMENT *el_pt = <span class="keyword">dynamic_cast&lt;</span>ELEMENT*<span class="keyword">&gt;</span>(Bulk_mesh_pt-&gt;</div>
<div class="line">                                           bulk_element_pt(i));</div>
<div class="line">   <span class="comment">//Set the Reynolds number, etc</span></div>
<div class="line">   el_pt-&gt;re_pt() = &amp;<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#ab814e627d2eb5bc50318879d19ab16b9">Global_Physical_Variables::Re</a>;</div>
<div class="line">   el_pt-&gt;re_st_pt() = &amp;<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a085ee4bf968ffdd01a41b8c41864f907">Global_Physical_Variables::ReSt</a>;</div>
<div class="line">   el_pt-&gt;re_invfr_pt() = &amp;<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#aa6286f02b476912dd7550eced538331a">Global_Physical_Variables::ReInvFr</a>;</div>
<div class="line">   el_pt-&gt;g_pt() = &amp;<a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a37a6f46efcb35b4bd12c73f19d741020">Global_Physical_Variables::G</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Loop over 1D interface elements and set capillary number</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> interface_element_pt_range = Bulk_mesh_pt-&gt;ninterface_element();</div>
<div class="line"> <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> i=0;i&lt;interface_element_pt_range;i++)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">//Cast to a interface element</span></div>
<div class="line">   SpineLineFluidInterfaceElement&lt;ELEMENT&gt;* el_pt = </div>
<div class="line">    <span class="keyword">dynamic_cast&lt;</span>SpineLineFluidInterfaceElement&lt;ELEMENT&gt;*<span class="keyword">&gt;</span></div>
<div class="line">    (Bulk_mesh_pt-&gt;interface_element_pt(i));</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Set the Capillary number</span></div>
<div class="line">   el_pt-&gt;ca_pt() = &amp;<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Update the nodal positions, so that the domain is correct</span></div>
<div class="line"> <span class="comment">//(and therefore the repeated node test passes)</span></div>
<div class="line"> Bulk_mesh_pt-&gt;node_update();</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Do equation numbering</span></div>
<div class="line"> cout &lt;&lt; <span class="stringliteral">&quot;Number of unknowns: &quot;</span> &lt;&lt; assign_eqn_numbers() &lt;&lt; std::endl; </div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//========================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Activate the dependency of the inflow velocity on the </span></div>
<div class="line"><span class="comment">/// spine heights at the outflow</span></div>
<div class="line"><span class="comment"></span><span class="comment">//========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#a04257edfb80f2ff3bf865442d9eb01fb">BrethertonProblem&lt;ELEMENT&gt;::activate_inflow_dependency</a>()</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Spine heights that affect the inflow</span></div>
<div class="line"> Vector&lt;Data*&gt; outflow_spines(2);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// First spine</span></div>
<div class="line"> outflow_spines[0]=Bulk_mesh_pt-&gt;spine_pt(0)-&gt;spine_height_pt();</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Last proper spine</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> last_spine=Bulk_mesh_pt-&gt;nfree_surface_spines()-1;</div>
<div class="line"> outflow_spines[1]=Bulk_mesh_pt-&gt;spine_pt(last_spine)-&gt;spine_height_pt();;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment"> /// Loop over elements on inflow boundary (1)</span></div>
<div class="line"><span class="comment"></span> <span class="keywordtype">unsigned</span> ibound=1;</div>
<div class="line"> <span class="keywordtype">unsigned</span> nel=Bulk_mesh_pt-&gt;nboundary_element(ibound);</div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> e=0;e&lt;nel;e++)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Get pointer to element</span></div>
<div class="line">   ELEMENT* el_pt=<span class="keyword">dynamic_cast&lt;</span>ELEMENT*<span class="keyword">&gt;</span>(Bulk_mesh_pt-&gt;</div>
<div class="line">                                         boundary_element_pt(ibound,e));  </div>
<div class="line">   <span class="comment">// Activate depency on inflow</span></div>
<div class="line">   el_pt-&gt;activate_inflow_dependency_on_external_data(</div>
<div class="line">    outflow_spines,ibound,&amp;<a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a08e9835d71b7f7194ec5475f139211be">Global_Physical_Variables::inflow</a>);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//========================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Doc the solution</span></div>
<div class="line"><span class="comment"></span><span class="comment">//========================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#ab6e29ecf0dbffabd4ce897203d35626e">BrethertonProblem&lt;ELEMENT&gt;::doc_solution</a>(DocInfo&amp; doc_info)</div>
<div class="line">{ </div>
<div class="line"> </div>
<div class="line"> ofstream some_file;</div>
<div class="line"> <span class="keywordtype">char</span> filename[100];</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of plot points</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> npts=5; </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Control coordinate: At bubble tip</span></div>
<div class="line"> Vector&lt;double&gt; s(2);</div>
<div class="line"> s[0]=1.0;</div>
<div class="line"> s[1]=1.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Last proper spine</span></div>
<div class="line"> <span class="keywordtype">unsigned</span> last_spine=Bulk_mesh_pt-&gt;nfree_surface_spines()-1;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Doc</span></div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Bulk_mesh_pt-&gt;spine_pt(0)-&gt;height();</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Bulk_mesh_pt-&gt;spine_pt(last_spine)-&gt;height();</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.3375*pow(<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a>,2.0/3.0);</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; -Control_element_pt-&gt;interpolated_p_nst(s)*</div>
<div class="line">                      <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; 1.0+3.8*pow(<a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a>,2.0/3.0);</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Control_element_pt-&gt;interpolated_u_nst(s,0);</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; Control_element_pt-&gt;interpolated_u_nst(s,1);</div>
<div class="line"> Trace_file &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Output solution </span></div>
<div class="line"> snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/soln%i.dat&quot;</span>,doc_info.directory().c_str(),</div>
<div class="line">         doc_info.number());</div>
<div class="line"> some_file.open(filename);</div>
<div class="line"> Bulk_mesh_pt-&gt;output(some_file,npts);</div>
<div class="line"> some_file.close();</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Output boundaries</span></div>
<div class="line"> snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/boundaries%i.dat&quot;</span>,doc_info.directory().c_str(),</div>
<div class="line">         doc_info.number());</div>
<div class="line"> some_file.open(filename);</div>
<div class="line"> Bulk_mesh_pt-&gt;output_boundaries(some_file);</div>
<div class="line"> some_file.close();</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//=============================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Parameter study</span></div>
<div class="line"><span class="comment"></span><span class="comment">//=============================================================================</span></div>
<div class="line"><span class="keyword">template</span>&lt;<span class="keyword">class</span> ELEMENT&gt;</div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="classBrethertonProblem.html#ac24db9373e1a3005e6b14fc92c16b41c">BrethertonProblem&lt;ELEMENT&gt;::parameter_study</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span>&amp; nsteps)</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Increase maximum residual</span></div>
<div class="line"> Problem::Max_residuals=500.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set output directory</span></div>
<div class="line"> DocInfo doc_info;</div>
<div class="line"> doc_info.set_directory(<span class="stringliteral">&quot;RESLT&quot;</span>);</div>
<div class="line"> doc_info.number()=0;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Open trace file</span></div>
<div class="line"> <span class="keywordtype">char</span> filename[100];   </div>
<div class="line"> snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/trace.dat&quot;</span>,doc_info.directory().c_str());</div>
<div class="line"> Trace_file.open(filename);</div>
<div class="line"> </div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;VARIABLES=\&quot;Ca\&quot;,&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;h&lt;sub&gt;bottom&lt;/sub&gt;\&quot;,\&quot;h&lt;sub&gt;too&lt;/sub&gt;\&quot;,&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;h&lt;sub&gt;Bretherton&lt;/sub&gt;\&quot;,\&quot;p&lt;sub&gt;tip&lt;/sub&gt;\&quot;,&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;p&lt;sub&gt;tip (Bretherton)&lt;/sub&gt;\&quot;,\&quot;u&lt;sub&gt;stag&lt;/sub&gt;\&quot;,&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;v&lt;sub&gt;stag&lt;/sub&gt;\&quot;&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;&lt;greek&gt;a&lt;/greek&gt;&lt;sub&gt;bottom&lt;/sub&gt;\&quot;,&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; <span class="stringliteral">&quot;\&quot;&lt;greek&gt;a&lt;/greek&gt;&lt;sub&gt;top&lt;/sub&gt;\&quot;&quot;</span>;</div>
<div class="line"> Trace_file &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Initial scaling factor for Ca reduction</span></div>
<div class="line"> <span class="keywordtype">double</span> factor=2.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Doc initial solution</span></div>
<div class="line"> doc_solution(doc_info);</div>
<div class="line"> </div>
<div class="line"><span class="comment">//Loop over the steps</span></div>
<div class="line"> <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> step=1;step&lt;=nsteps;step++)</div>
<div class="line">  {</div>
<div class="line">   cout &lt;&lt; std::endl &lt;&lt; <span class="stringliteral">&quot;STEP &quot;</span> &lt;&lt; step &lt;&lt; std::endl;</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Newton method tends to converge is initial stays bounded below</span></div>
<div class="line">   <span class="comment">// a certain tolerance: This is cheaper to check than restarting</span></div>
<div class="line">   <span class="comment">// the Newton method after divergence (we&#39;d also need to back up</span></div>
<div class="line">   <span class="comment">// the previous solution)</span></div>
<div class="line">   <span class="keywordtype">double</span> maxres = Problem::Max_residuals;</div>
<div class="line">   <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">     cout &lt;&lt; <span class="stringliteral">&quot;Checking max. res for Ca = &quot;</span> </div>
<div class="line">          &lt;&lt; <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> &lt;&lt; <span class="stringliteral">&quot;.   Max. residual: &quot;</span>;</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// Check the maximum residual</span></div>
<div class="line">     DoubleVector residuals;</div>
<div class="line">     actions_before_newton_solve();</div>
<div class="line">     actions_before_newton_convergence_check();</div>
<div class="line">     get_residuals(residuals);</div>
<div class="line">     <span class="keywordtype">double</span> max_res=residuals.max();</div>
<div class="line">     cout &lt;&lt; max_res;</div>
<div class="line"> </div>
<div class="line">     <span class="comment">// Check what to do </span></div>
<div class="line">     <span class="keywordflow">if</span> (max_res&gt;maxres)</div>
<div class="line">      {</div>
<div class="line">       cout &lt;&lt; <span class="stringliteral">&quot;. Too big!&quot;</span> &lt;&lt; std::endl;</div>
<div class="line">       <span class="comment">// Reset the capillary number</span></div>
<div class="line">       <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> *= factor;       </div>
<div class="line">       <span class="comment">// Reduce the factor</span></div>
<div class="line">       factor=1.0+(factor-1.0)/1.5;</div>
<div class="line">       cout &lt;&lt; <span class="stringliteral">&quot;New reduction factor: &quot;</span> &lt;&lt; factor &lt;&lt; std::endl;</div>
<div class="line">       <span class="comment">// Reduce the capillary number</span></div>
<div class="line">       <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> /= factor;</div>
<div class="line">       <span class="comment">// Try again</span></div>
<div class="line">       <span class="keywordflow">continue</span>;</div>
<div class="line">      }</div>
<div class="line">     <span class="comment">// Looks promising: Let&#39;s proceed to solve</span></div>
<div class="line">     <span class="keywordflow">else</span></div>
<div class="line">      {</div>
<div class="line">       cout &lt;&lt; <span class="stringliteral">&quot;. OK&quot;</span> &lt;&lt; std::endl &lt;&lt; std::endl;</div>
<div class="line">       <span class="comment">// Break out of the Ca adjustment loop</span></div>
<div class="line">       <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">   <span class="comment">//Solve</span></div>
<div class="line">   cout &lt;&lt; <span class="stringliteral">&quot;Solving for capillary number: &quot;</span> </div>
<div class="line">        &lt;&lt; <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> &lt;&lt; std::endl;</div>
<div class="line">   newton_solve();</div>
<div class="line"> </div>
<div class="line">   <span class="comment">// Doc solution</span></div>
<div class="line">   doc_info.number()++;</div>
<div class="line">   doc_solution(doc_info);</div>
<div class="line">   </div>
<div class="line">   <span class="comment">// Reduce the capillary number</span></div>
<div class="line">   <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> /= factor;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//======================================================================</span><span class="comment"></span></div>
<div class="line"><span class="comment">/// Driver code for unsteady two-layer fluid problem. If there are</span></div>
<div class="line"><span class="comment">/// any command line arguments, we regard this as a validation run</span></div>
<div class="line"><span class="comment">/// and perform only a single step.</span></div>
<div class="line"><span class="comment"></span><span class="comment">//======================================================================</span></div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="bretherton_8cc.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[]) </div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Store command line arguments</span></div>
<div class="line"> CommandLineArgs::setup(argc,argv);</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Set physical parameters:</span></div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Set direction of gravity: Vertically downwards</span></div>
<div class="line"> <a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a37a6f46efcb35b4bd12c73f19d741020">Global_Physical_Variables::G</a>[0] = 0.0;</div>
<div class="line"> <a class="code hl_function" href="namespaceGlobal__Physical__Variables.html#a37a6f46efcb35b4bd12c73f19d741020">Global_Physical_Variables::G</a>[1] = -1.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Womersley number = Reynolds number (St = 1)</span></div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a085ee4bf968ffdd01a41b8c41864f907">Global_Physical_Variables::ReSt</a> = 0.0;</div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#ab814e627d2eb5bc50318879d19ab16b9">Global_Physical_Variables::Re</a> = <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a085ee4bf968ffdd01a41b8c41864f907">Global_Physical_Variables::ReSt</a>;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// The Capillary number</span></div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a> = 0.05;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Re/Fr -- a measure of gravity...</span></div>
<div class="line"> <a class="code hl_variable" href="namespaceGlobal__Physical__Variables.html#aa6286f02b476912dd7550eced538331a">Global_Physical_Variables::ReInvFr</a> = 0.0;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">//Set up the problem</span></div>
<div class="line"> <a class="code hl_class" href="classBrethertonProblem.html">BrethertonProblem&lt;BrethertonElement&lt;SpineElement&lt;QCrouzeixRaviartElement&lt;2&gt;</a> &gt; &gt; &gt; problem;</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Self test:</span></div>
<div class="line"> problem.self_test();</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Number of steps: </span></div>
<div class="line"> <span class="keywordtype">unsigned</span> nstep;</div>
<div class="line"> <span class="keywordflow">if</span> (CommandLineArgs::Argc&gt;1)</div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Validation run: Just one step</span></div>
<div class="line">   nstep=2;</div>
<div class="line">  }</div>
<div class="line"> <span class="keywordflow">else</span></div>
<div class="line">  {</div>
<div class="line">   <span class="comment">// Full run otherwise</span></div>
<div class="line">   nstep=30;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line"> <span class="comment">// Run the parameter study: Perform nstep steps</span></div>
<div class="line"> problem.<a class="code hl_function" href="classBrethertonProblem.html#ac24db9373e1a3005e6b14fc92c16b41c">parameter_study</a>(nstep);</div>
<div class="line"> </div>
<div class="line">}</div>
<div class="line"> </div>
<div class="ttc" id="abretherton_8cc_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="bretherton_8cc.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdoc">Driver code for unsteady two-layer fluid problem. If there are any command line arguments,...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00916">bretherton.cc:916</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html"><div class="ttname"><a href="classBrethertonElement.html">BrethertonElement</a></div><div class="ttdoc">&quot;Bretherton element&quot; is a fluid element (of type ELEMENT) for which the (inflow) velocity at those no...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00153">bretherton.cc:154</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a2d3a3d4837d41865d5f62271c98715c5"><div class="ttname"><a href="classBrethertonElement.html#a2d3a3d4837d41865d5f62271c98715c5">BrethertonElement::Inflow_boundary</a></div><div class="ttdeci">unsigned Inflow_boundary</div><div class="ttdoc">Number of the inflow boundary in the global mesh.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00390">bretherton.cc:390</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a313d868ce6fbd8df07b0360db25133ce"><div class="ttname"><a href="classBrethertonElement.html#a313d868ce6fbd8df07b0360db25133ce">BrethertonElement::InflowFctPt</a></div><div class="ttdeci">void(* InflowFctPt)(const Vector&lt; double &gt; &amp;x, Vector&lt; double &gt; &amp;veloc)</div><div class="ttdoc">Typedef for pointer (global) function that specifies the the inflow.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00160">bretherton.cc:160</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a40f35d9e03eae08954b6b32badadcf61"><div class="ttname"><a href="classBrethertonElement.html#a40f35d9e03eae08954b6b32badadcf61">BrethertonElement::assign_local_eqn_numbers</a></div><div class="ttdeci">void assign_local_eqn_numbers(const bool &amp;store_local_dof_pt)</div><div class="ttdoc">Overload assign local equation numbers: Add the dependency on the external Data that affects the infl...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00192">bretherton.cc:192</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a5a8333b92b4b732e62798c172d7e9d52"><div class="ttname"><a href="classBrethertonElement.html#a5a8333b92b4b732e62798c172d7e9d52">BrethertonElement::activate_inflow_dependency_on_external_data</a></div><div class="ttdeci">void activate_inflow_dependency_on_external_data(const Vector&lt; Data * &gt; &amp;inflow_ext_data, const unsigned &amp;inflow_boundary, InflowFctPt inflow_fct_pt)</div><div class="ttdoc">Activate the dependency of the &quot;inflow&quot; on the external data. Pass the vector of pointers to the exte...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00171">bretherton.cc:171</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a6ded0faba9d7fcfe96834c56af461977"><div class="ttname"><a href="classBrethertonElement.html#a6ded0faba9d7fcfe96834c56af461977">BrethertonElement::Inflow_fct_pt</a></div><div class="ttdeci">InflowFctPt Inflow_fct_pt</div><div class="ttdoc">Function pointer to the global function that specifies the inflow velocity profile on the global mesh...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00394">bretherton.cc:394</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a7e655df2ed6104862cc70c2408daf93c"><div class="ttname"><a href="classBrethertonElement.html#a7e655df2ed6104862cc70c2408daf93c">BrethertonElement::reassign_inflow</a></div><div class="ttdeci">void reassign_inflow()</div><div class="ttdoc">For all nodes that are located on specified boundary re-assign the inflow velocity,...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00339">bretherton.cc:339</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_a84c7822cf2a97fe45e936429faa16788"><div class="ttname"><a href="classBrethertonElement.html#a84c7822cf2a97fe45e936429faa16788">BrethertonElement::Inflow_ext_data</a></div><div class="ttdeci">Vector&lt; Data * &gt; Inflow_ext_data</div><div class="ttdoc">Storage for the external Data that affects the inflow.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00383">bretherton.cc:383</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_ab0bc00d862b2c888703ed38c74f18b77"><div class="ttname"><a href="classBrethertonElement.html#ab0bc00d862b2c888703ed38c74f18b77">BrethertonElement::get_jacobian</a></div><div class="ttdeci">void get_jacobian(Vector&lt; double &gt; &amp;residuals, DenseMatrix&lt; double &gt; &amp;jacobian)</div><div class="ttdoc">Overloaded Jacobian computation: Computes the Jacobian of the underlying element and then adds the FD...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00261">bretherton.cc:261</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_acbc668eed3ea683a67b6b822d6e59974"><div class="ttname"><a href="classBrethertonElement.html#acbc668eed3ea683a67b6b822d6e59974">BrethertonElement::BrethertonElement</a></div><div class="ttdeci">BrethertonElement()</div><div class="ttdoc">Constructor: Call the constructor of the underlying element.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00163">bretherton.cc:163</a></div></div>
<div class="ttc" id="aclassBrethertonElement_html_ad1ddf8c7a6fd590bf7156d13640303d1"><div class="ttname"><a href="classBrethertonElement.html#ad1ddf8c7a6fd590bf7156d13640303d1">BrethertonElement::Inflow_ext_data_eqn</a></div><div class="ttdeci">DenseMatrix&lt; int &gt; Inflow_ext_data_eqn</div><div class="ttdoc">Storage for the local equation numbers associated the Data values that affect the inflow.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00387">bretherton.cc:387</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html"><div class="ttname"><a href="classBrethertonProblem.html">BrethertonProblem</a></div><div class="ttdoc">Bretherton problem.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00464">bretherton.cc:465</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_a04257edfb80f2ff3bf865442d9eb01fb"><div class="ttname"><a href="classBrethertonProblem.html#a04257edfb80f2ff3bf865442d9eb01fb">BrethertonProblem::activate_inflow_dependency</a></div><div class="ttdeci">void activate_inflow_dependency()</div><div class="ttdoc">Activate the dependency of the inflow velocity on the spine heights at the outflow.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00726">bretherton.cc:726</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_a207cdfe4cf60e83257e759b1ac15e5eb"><div class="ttname"><a href="classBrethertonProblem.html#a207cdfe4cf60e83257e759b1ac15e5eb">BrethertonProblem::BrethertonProblem</a></div><div class="ttdeci">BrethertonProblem()</div><div class="ttdoc">Constructor:</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00551">bretherton.cc:551</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_a2e84e3ce784b0f0de5eeefe1175d48ff"><div class="ttname"><a href="classBrethertonProblem.html#a2e84e3ce784b0f0de5eeefe1175d48ff">BrethertonProblem::actions_after_newton_solve</a></div><div class="ttdeci">void actions_after_newton_solve()</div><div class="ttdoc">Update after solve can remain empty, because the update is performed automatically after every Newton...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00509">bretherton.cc:509</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_a6a3e76e4900715d8c2fd15d0e350d724"><div class="ttname"><a href="classBrethertonProblem.html#a6a3e76e4900715d8c2fd15d0e350d724">BrethertonProblem::actions_before_newton_convergence_check</a></div><div class="ttdeci">void actions_before_newton_convergence_check()</div><div class="ttdoc">Spine heights/lengths are unknowns in the problem so their values get corrected during each Newton st...</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00477">bretherton.cc:477</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_a7112e0efe4c0cd0269cf47f02df4fe22"><div class="ttname"><a href="classBrethertonProblem.html#a7112e0efe4c0cd0269cf47f02df4fe22">BrethertonProblem::actions_before_newton_solve</a></div><div class="ttdeci">void actions_before_newton_solve()</div><div class="ttdoc">Update before solve: empty.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00505">bretherton.cc:505</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_aa4c346d4dc8d7d24147076d281d181e9"><div class="ttname"><a href="classBrethertonProblem.html#aa4c346d4dc8d7d24147076d281d181e9">BrethertonProblem::fix_pressure</a></div><div class="ttdeci">void fix_pressure(const unsigned &amp;e, const unsigned &amp;l, const double &amp;pvalue)</div><div class="ttdoc">Fix pressure value l in element e to value p_value.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00512">bretherton.cc:512</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_ab1dfeabf599487ac4a121398c6a98368"><div class="ttname"><a href="classBrethertonProblem.html#ab1dfeabf599487ac4a121398c6a98368">BrethertonProblem::Control_element_pt</a></div><div class="ttdeci">ELEMENT * Control_element_pt</div><div class="ttdoc">Pointer to control element.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00535">bretherton.cc:535</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_ab6e29ecf0dbffabd4ce897203d35626e"><div class="ttname"><a href="classBrethertonProblem.html#ab6e29ecf0dbffabd4ce897203d35626e">BrethertonProblem::doc_solution</a></div><div class="ttdeci">void doc_solution(DocInfo &amp;doc_info)</div><div class="ttdoc">Doc the solution.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00762">bretherton.cc:762</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_ac24db9373e1a3005e6b14fc92c16b41c"><div class="ttname"><a href="classBrethertonProblem.html#ac24db9373e1a3005e6b14fc92c16b41c">BrethertonProblem::parameter_study</a></div><div class="ttdeci">void parameter_study(const unsigned &amp;nsteps)</div><div class="ttdoc">Run a parameter study; perform specified number of steps.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00816">bretherton.cc:816</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_ae37c09c1e0faf5ba8b347fab6a9f687f"><div class="ttname"><a href="classBrethertonProblem.html#ae37c09c1e0faf5ba8b347fab6a9f687f">BrethertonProblem::Trace_file</a></div><div class="ttdeci">ofstream Trace_file</div><div class="ttdoc">Trace file.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00538">bretherton.cc:538</a></div></div>
<div class="ttc" id="aclassBrethertonProblem_html_af293d72416de7a93ed51f20a5e4fb86e"><div class="ttname"><a href="classBrethertonProblem.html#af293d72416de7a93ed51f20a5e4fb86e">BrethertonProblem::Bulk_mesh_pt</a></div><div class="ttdeci">BrethertonSpineMesh&lt; ELEMENT, SpineLineFluidInterfaceElement&lt; ELEMENT &gt; &gt; * Bulk_mesh_pt</div><div class="ttdoc">Pointer to bulk mesh.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00542">bretherton.cc:542</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html">Global_Physical_Variables</a></div><div class="ttdoc">Namepspace for global parameters.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00044">bretherton.cc:45</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a085ee4bf968ffdd01a41b8c41864f907"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a085ee4bf968ffdd01a41b8c41864f907">Global_Physical_Variables::ReSt</a></div><div class="ttdeci">double ReSt</div><div class="ttdoc">Womersley = Reynolds times Strouhal.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00051">bretherton.cc:51</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a08e9835d71b7f7194ec5475f139211be"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a08e9835d71b7f7194ec5475f139211be">Global_Physical_Variables::inflow</a></div><div class="ttdeci">void inflow(const Vector&lt; double &gt; &amp;x, Vector&lt; double &gt; &amp;veloc)</div><div class="ttdoc">Set inflow velocity, based on spine heights at outflow and channel width at inflow.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00076">bretherton.cc:76</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a137bdac2ad4b72a03ec9916e8ee7395b"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a137bdac2ad4b72a03ec9916e8ee7395b">Global_Physical_Variables::H_lo_pt</a></div><div class="ttdeci">double * H_lo_pt</div><div class="ttdoc">Pointer to film thickness at outflow on the lower wall.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00063">bretherton.cc:63</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a37a6f46efcb35b4bd12c73f19d741020"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a37a6f46efcb35b4bd12c73f19d741020">Global_Physical_Variables::G</a></div><div class="ttdeci">Vector&lt; double &gt; G(2)</div><div class="ttdoc">Direction of gravity.</div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a75878a0c79c88065fd9031f273b62698"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a75878a0c79c88065fd9031f273b62698">Global_Physical_Variables::Y_up_pt</a></div><div class="ttdeci">double * Y_up_pt</div><div class="ttdoc">Pointer to y-position at inflow on the upper wall.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00072">bretherton.cc:72</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a83a3a82f89784013805bd23d63faa7e3"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a83a3a82f89784013805bd23d63faa7e3">Global_Physical_Variables::H_up_pt</a></div><div class="ttdeci">double * H_up_pt</div><div class="ttdoc">Pointer to film thickness at outflow on the upper wall.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00066">bretherton.cc:66</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a84caa2a64e50ba5b390a3cd100f0f835"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a84caa2a64e50ba5b390a3cd100f0f835">Global_Physical_Variables::Y_lo_pt</a></div><div class="ttdeci">double * Y_lo_pt</div><div class="ttdoc">Pointer to y-position at inflow on the lower wall.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00069">bretherton.cc:69</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_a8b32b93d2e546f9375ec418474107838"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#a8b32b93d2e546f9375ec418474107838">Global_Physical_Variables::Ca</a></div><div class="ttdeci">double Ca</div><div class="ttdoc">Capillary number.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00057">bretherton.cc:57</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_aa6286f02b476912dd7550eced538331a"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#aa6286f02b476912dd7550eced538331a">Global_Physical_Variables::ReInvFr</a></div><div class="ttdeci">double ReInvFr</div><div class="ttdoc">Product of Reynolds and Froude number.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00054">bretherton.cc:54</a></div></div>
<div class="ttc" id="anamespaceGlobal__Physical__Variables_html_ab814e627d2eb5bc50318879d19ab16b9"><div class="ttname"><a href="namespaceGlobal__Physical__Variables.html#ab814e627d2eb5bc50318879d19ab16b9">Global_Physical_Variables::Re</a></div><div class="ttdeci">double Re</div><div class="ttdoc">Reynolds number.</div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00048">bretherton.cc:48</a></div></div>
<div class="ttc" id="anamespaceoomph_html"><div class="ttname"><a href="namespaceoomph.html">oomph</a></div><div class="ttdef"><b>Definition</b> <a href="bretherton_8cc_source.html#l00401">bretherton.cc:402</a></div></div>
</div><!-- fragment --><h1><a class="anchor" id="sources"></a>
Source files for this tutorial</h1>
<ul>
<li>The source files for this tutorial are located in the directory:<br  />
<br  />
<center> <a href="../../../../demo_drivers/navier_stokes/bretherton">demo_drivers/navier_stokes/bretherton </a> </center><br  />
</li>
<li>The driver code is: <br  />
<br  />
<center> <a href="../../../../demo_drivers/navier_stokes/bretherton/bretherton.cc">demo_drivers/navier_stokes/bretherton/bretherton.cc</a> </center></li>
</ul>
<hr  />
 <hr  />
 <h1><a class="anchor" id="pdf"></a>
PDF file</h1>
<p>A <a href="../latex/refman.pdf">pdf version</a> of this document is available. \ </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->

    <!-- jQuery for Bootstrap and Doxygen -->
    <script src="../../../js/jquery-1.12.0.min.js"></script>
    <!-- Minified boostrap plugins-->
    <script src="../../../js/bootstrap.js"></script>
    <!-- Doxygen dependency to add powertips to source code-->
    <script src="../../../js/jquery.powertip.min.js"></script>
    <!-- The  following script is generated by doxygen and hides/shows levels in 
         the data structure lists and adds powertips to source code-->
    <script src="../../../js/dynsections.js" ></script>
    <!-- add to Doxygen's class names so bootstrap css and js recognises them-->
    <script type="text/javascript">
    $(".contents").addClass("container");
    $(".header").addClass("container");
    $(".navpath").addClass("container");
    $("#navrow3").addClass("container");
    $("#navrow4").addClass("container");
    $(".mlabel").addClass("label");
    $(".mlabel").addClass("label-default");
    $(".memitem").addClass("panel");
    $(".memitem").addClass("panel-info");
    $(".memproto").addClass("panel-heading");
    $(".memdoc").addClass("panel-body");
    </script>
    <footer>
      <div class="container">
        <div class="text-muted" style="float:right;">Generated by <a href="http://www.doxygen.org/index.html">
          <img style="height:18px;" class="footer-img" src="doxygen.png" alt="doxygen"></a> on Tue Jan 13 2026 16:19:47
        </div>
      </div>
    </footer>
</body>
</html>
